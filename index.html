<!DOCTYPE html>
<!-- MODIFIED: Removed 'dark' class to default to light mode -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decom Board</title>
    <!-- 1. Include Tailwind CSS for all the "beauty" -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. ADDED: PeerJS for real-time sync -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <!-- 3. ADDED: QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- 4. ADDED: QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script>
        // 5. Configure Tailwind
        tailwind.config = {
            // ... (Tailwind config remains the same) ...
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        /* MODIFIED: New color palette based on image */
                        'kanban-bg': '#3498db', // A nice blue/teal
                        'kanban-section-body': '#f3f4f6', // Light gray for section body
                        'kanban-card': '#ffffff', // White
                        'kanban-footer': '#ffffff', // White footer
                    }
                }
            }
        }
    </script>
    <!-- 6. Get the "Inter" font for that clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 7. All our custom styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* ADDED: Prevent pull-to-refresh on mobile */
            overflow: hidden;
            height: 100vh;
        }
        /* Style for the card being dragged */
        .dragging {
            opacity: 0.8;
            transform: rotate(2deg);
            background: #e0e7ff; /* Light indigo */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        /* Style for the placeholder where the card will drop */
        .drag-placeholder {
            background: rgba(0, 0, 0, 0.05);
            border: 2px dashed #4f46e5;
            border-radius: 0.5rem;
            flex-shrink: 0;
        }
        .section-placeholder { /* New class for vertical sections */
            width: 100%;
            margin: 0.5rem 0;
        }
        .staging-placeholder { /* New class for horizontal */
            margin: 0 0.5rem;
        }
        /* Hide the native file input */
        #file-input {
            display: none;
        }
        /* The file-drop overlay */
        #drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border: 4px dashed #4f46e5;
        }
        #drop-zone.active {
            display: flex; /* Shown when dragging a file over */
        }
        
        /* Modal Styles */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        #modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none; /* Hidden by default */
            width: 90%;
            max-width: 500px;
            background-color: #ffffff;
            color: #111827;
        }
        #modal-container.active,
        #modal-backdrop.active {
            display: block;
        }
        
        /* Custom scrollbar for horizontal board */
        .horizontal-scroll {
            scrollbar-color: #4f46e5 #d1d5db;
            scrollbar-width: thin;
        }
        .horizontal-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .horizontal-scroll::-webkit-scrollbar-track {
            background: #d1d5db;
            border-radius: 10px;
        }
        .horizontal-scroll::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
        }

        /* Styles for the color swatches in the modal */
        .color-swatch {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .color-swatch.selected,
        .color-swatch:hover {
            border-color: #111827; /* Dark border for selected */
            transform: scale(1.1);
        }

        /* --- ADDED: Mobile & Chat Styles --- */

        /* By default, show desktop and hide mobile */
        #desktop-ui {
            display: flex; /* This is the main flex container */
            flex-direction: column;
            height: 100vh;
        }
        #mobile-ui { display: none; }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            #desktop-ui { display: none; }
            #mobile-ui {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
                background-color: #f3f4f6; /* Light gray bg for mobile */
            }

            /* Mobile Swiper for sections */
            #mobile-swiper {
                flex: 1;
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                scrollbar-width: none; /* Hide scrollbar */
                -ms-overflow-style: none; /* Hide scrollbar */
            }
            #mobile-swiper::-webkit-scrollbar { display: none; }
            
            #mobile-swiper > .kanban-section {
                flex: 0 0 100%; /* Each section is full width */
                scroll-snap-align: center;
                height: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                border: none;
            }

            /* Mobile Staging Area (Pull-up Drawer) */
            #mobile-staging-toggle {
                flex-shrink: 0;
                background-color: #ffffff;
                border-top: 1px solid #d1d5db;
                padding: 1rem;
                font-weight: 600;
                text-align: center;
                cursor: pointer;
            }
            #mobile-staging-drawer {
                flex-shrink: 0;
                background-color: #e5e7eb;
                height: 200px; /* Fixed height */
                overflow-x: auto;
                display: flex;
                align-items: center;
                padding: 1rem;
                gap: 1rem;
                display: none; /* Hidden by default */
            }
            #mobile-staging-drawer.active {
                display: flex;
            }
            #mobile-add-card-btn {
                 height: 100%;
                 min-width: 150px;
            }
        }
        
        /* Chat Bubble FAB */
        #chat-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4f46e5;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none; /* Hidden until session starts */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 990;
        }
        /* Bouncing animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        #chat-fab.bouncing {
            animation: bounce 0.6s 2;
        }
        
        /* Chat Window */
        #chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 989;
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
        }
        #chat-window.active { display: flex; }
        #chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* New messages at bottom */
        }
        #chat-messages div {
            margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            max-width: 80%;
        }
        #chat-messages .my-message {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        #chat-messages .peer-message {
            background-color: #e5e7eb;
            color: #111827;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
        #chat-input-area {
            display: flex;
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem;
        }
        #chat-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 99px;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
        }
        #chat-send-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        /* QR Code Scanner UI */
        #qr-reader {
            width: 100%;
            border: 2px dashed #4f46e5;
            border-radius: 8px;
        }

    </style>
</head>
<!-- MODIFIED: New bg color, new text color -->
<!-- MODIFIED: Removed overflow-hidden to allow full page scroll if needed -->
<body class="bg-kanban-bg text-gray-900 h-screen flex flex-col">

    <!-- =========== DESKTOP UI =========== -->
    <div id="desktop-ui">
        <!-- KANBAN BOARD -->
        <main id="board-container" class="flex-1 flex gap-6 p-6 overflow-x-auto horizontal-scroll">
            <!-- Sections and cards will be dynamically generated here -->
            <!-- Add Section button will be appended here by JS -->
        </main>
        
        <!-- STAGING AREA FOOTER -->
        <footer class="flex-shrink-0 bg-kanban-footer border-t border-gray-200 shadow-inner">
            <div class="flex justify-between items-center px-6 pt-4">
                <div class="flex items-center space-x-4">
                    <h2 class="text-lg font-semibold text-gray-700">Staging Area</h2>
                    <!-- ADDED: Collaboration Buttons -->
                    <button id="start-session-btn" class="px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-500 transition-all">Start Session</button>
                    <button id="join-session-btn-desktop" class="px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-500 transition-all">Join Session</button>
                    <div id="connection-status" class="text-sm text-gray-500">Offline</div>
                </div>
                <!-- MODIFIED: Added Save/Load buttons here -->
                <div class="flex items-center space-x-3">
                    <button id="save-btn" title="Save as .mim backup" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <button id="load-btn" title="Load from .mim file" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L9 7.586V15a1 1 0 11-2 0V7.586L5.707 8.707a1 1 0 01-1.414-1.414l3-3z" clip-rule="evenodd" /></svg>
                    </button>
                    <input type="file" id="file-input" accept=".mim">
                </div>
            </div>

            <div id="staging-area" class="card-list flex items-center gap-4 p-6 pt-4 overflow-x-auto horizontal-scroll" data-section-id="staging">
                <button id="add-card-btn" class="w-64 h-24 flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                    + Add New Card
                </button>
            </div>
        </footer>
    </div>
    
    <!-- =========== MOBILE UI =========== -->
    <div id="mobile-ui">
        <!-- Mobile Section Swiper -->
        <main id="mobile-swiper">
            <!-- Mobile sections injected here -->
        </main>
        
        <!-- Mobile Staging Area -->
        <footer class="flex-shrink-0">
            <div id="mobile-staging-toggle">Staging Area</div>
            <div id="mobile-staging-drawer" class="card-list" data-section-id="staging">
                <button id="mobile-add-card-btn" class="w-40 h-full flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-600 rounded-lg">
                    + Add Card
                </button>
                <!-- Mobile staging cards injected here -->
            </div>
        </footer>

        <!-- ADDED: Mobile "Join Session" button -->
        <button id="join-session-btn-mobile" class="absolute top-4 right-4 px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-500 transition-all z-50">
            Join
        </button>
        <div id="mobile-connection-status" class="absolute top-5 left-4 text-sm text-gray-500 z-50">Offline</div>
    </div>

    <!-- =========== SHARED UI (Modals, Chat, etc) =========== -->

    <!-- FILE DROP OVERLAY -->
    <div id="drop-zone"><!-- ... (no changes) ... --></div>
    
    <!-- MODAL UI -->
    <div id="modal-backdrop"></div>
    <div id="modal-container" class="bg-white rounded-lg shadow-2xl overflow-hidden">
        <div class="p-6">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-900 mb-6">Modal Title</h2>
            <div id="modal-content" class="text-gray-700">
                <!-- Modal content injected here -->
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-all">Cancel</button>
            <button id="modal-confirm-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-500 transition-all">Confirm</button>
        </div>
    </div>

    <!-- CHAT UI -->
    <div id="chat-fab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </div>
    <div id="chat-window">
        <div class="p-4 border-b font-semibold">Chat</div>
        <div id="chat-messages"><div class="peer-message" style="align-self: center; background: #f9fafb; color: #6b7280;">Session started...</div></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="chat-send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 m-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const boardContainer = document.getElementById('board-container');
        const stagingArea = document.getElementById('staging-area');
        const addCardBtn = document.getElementById('add-card-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        
        // --- ADDED: Mobile UI elements ---
        const mobileSwiper = document.getElementById('mobile-swiper');
        const mobileStagingToggle = document.getElementById('mobile-staging-toggle');
        const mobileStagingDrawer = document.getElementById('mobile-staging-drawer');
        const mobileAddCardBtn = document.getElementById('mobile-add-card-btn');
        const mobileJoinBtn = document.getElementById('join-session-btn-mobile');
        const mobileConnectionStatus = document.getElementById('mobile-connection-status');
        
        // --- ADDED: Collaboration UI elements ---
        const startSessionBtn = document.getElementById('start-session-btn');
        const joinSessionBtnDesktop = document.getElementById('join-session-btn-desktop');
        const connectionStatus = document.getElementById('connection-status');
        const chatFab = document.getElementById('chat-fab');
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        let state = {
            sections: [],
            cards: [],
            chat: []
        };
        
        let onModalConfirm = null; // Store the confirm action
        
        // --- ADDED: PeerJS variables ---
        let peer = null;
        let hostPeerId = null;
        let myPeerId = null;
        let isHost = false;
        let connections = []; // Host can have multiple connections
        let html5QrCode = null; // QR Scanner instance
        
        // --- CORE FUNCTIONS ---

        function saveState() {
            localStorage.setItem('decomBoardState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('decomBoardState');
            if (savedState) {
                state = JSON.parse(savedState);
                if (!state.chat) state.chat = []; // Add chat state if missing
                
                // ... (Data migration logic remains) ...
                let migrated = false;
                state.cards.forEach(card => {
                    if (card.hasOwnProperty('assetTag')) {
                        card.notes = card.assetTag;
                        delete card.assetTag;
                        migrated = true;
                    }
                });
                if (migrated) {
                    console.log("Data migrated: assetTag -> notes");
                    saveState();
                }

            } else {
                state = {
                    sections: [
                        { id: `sec-${Date.now()}`, title: "Backlog", color: "#ec4899" },
                        { id: `sec-${Date.now() + 1}`, title: "Doing", color: "#f59e0b" },
                        { id: `sec-${Date.now() + 2}`, title: "Done", color: "#10b981" }
                    ],
                    cards: [],
                    chat: []
                };
            }
        }
        
        // --- MODIFIED: Main Render Function ---
        function renderAll() {
            // Detect if mobile and render appropriate UI
            // This is a simple check, can be made more robust
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                renderMobileUI();
            } else {
                renderDesktopUI();
            }
            renderChat();
            attachEventListeners();
        }
        
        // --- NEW: Renders just the desktop UI ---
        function renderDesktopUI() {
            boardContainer.innerHTML = ''; // Clear the board

            // Render all sections
            state.sections.forEach(section => {
                const sectionEl = createSectionElement(section);
                
                const cardList = sectionEl.querySelector('.card-list');
                const sectionCards = state.cards
                    .filter(card => card.sectionId === section.id)
                    .sort((a, b) => a.order - b.order);

                sectionCards.forEach(card => {
                    const cardEl = createCardElement(card);
                    cardList.appendChild(cardEl);
                });
                
                boardContainer.appendChild(sectionEl);
            });
            
            // Add the "Add Section" button
            boardContainer.appendChild(createAddSectionButton());
            
            // Render Staging Area
            stagingArea.innerHTML = '';
            const stagingCards = state.cards
                .filter(card => card.sectionId === 'staging')
                .sort((a, b) => a.order - b.order);

            stagingCards.forEach(card => {
                const cardEl = createCardElement(card);
                stagingArea.appendChild(cardEl);
            });
            stagingArea.appendChild(addCardBtn);
        }
        
        // --- NEW: Renders just the mobile UI ---
        function renderMobileUI() {
            mobileSwiper.innerHTML = ''; // Clear swiper
            
            // Render sections into swiper
            state.sections.forEach(section => {
                const sectionEl = createSectionElement(section);
                
                const cardList = sectionEl.querySelector('.card-list');
                const sectionCards = state.cards
                    .filter(card => card.sectionId === section.id)
                    .sort((a, b) => a.order - b.order);

                sectionCards.forEach(card => {
                    const cardEl = createCardElement(card);
                    cardList.appendChild(cardEl);
                });
                
                mobileSwiper.appendChild(sectionEl);
            });
            
            // Add "Add Section" button to swiper
            mobileSwiper.appendChild(createAddSectionButton());
            
            // Render Staging Drawer
            mobileStagingDrawer.innerHTML = '';
            const stagingCards = state.cards
                .filter(card => card.sectionId === 'staging')
                .sort((a, b) => a.order - b.order);

            stagingCards.forEach(card => {
                const cardEl = createCardElement(card);
                mobileStagingDrawer.appendChild(cardEl);
            });
            mobileStagingDrawer.appendChild(mobileAddCardBtn);
        }
        
        // --- NEW: Helper to create a section element ---
        function createSectionElement(section) {
            const sectionEl = document.createElement('div');
            sectionEl.className = 'kanban-section w-80 rounded-lg shadow-xl flex flex-col flex-shrink-0 overflow-hidden';
            sectionEl.dataset.sectionId = section.id;
            
            const headerColor = section.color || '#6b7280';
            const headerTextColor = '#ffffff';

            sectionEl.innerHTML = `
                <div class="p-4 flex justify-between items-center" style="background-color: ${headerColor}; color: ${headerTextColor};">
                    <h2 class="font-semibold text-lg">${section.title}</h2>
                    <button class="delete-section-btn hover:text-gray-300" data-section-id="${section.id}" style="color: ${headerTextColor};">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="card-list flex-1 p-4 space-y-4 overflow-y-auto horizontal-scroll bg-kanban-section-body" data-section-id="${section.id}">
                    <!-- Cards go here -->
                </div>
            `;
            return sectionEl;
        }
        
        // --- NEW: Helper to create "Add Section" button ---
        function createAddSectionButton() {
            const addSectionBtnEl = document.createElement('button');
            addSectionBtnEl.id = 'add-section-btn';
            addSectionBtnEl.className = 'w-80 flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200/50 text-gray-600 rounded-lg hover:bg-gray-200 hover:text-gray-800 transition-all border-2 border-dashed border-gray-400';
            addSectionBtnEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 0V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2z" />
                </svg>
                + Add New Section
            `;
            return addSectionBtnEl;
        }

        /**
         * Creates a single card DOM element.
         */
        function createCardElement(card) {
            const cardEl = document.createElement('div');
            const isStaging = card.sectionId === 'staging';
            const cardWidthClass = isStaging ? 'w-64' : 'w-full';

            cardEl.className = `kanban-card p-4 bg-kanban-card text-gray-900 rounded-md shadow cursor-grab active:cursor-grabbing hover:shadow-lg transition-shadow ${cardWidthClass} flex-shrink-0`;
            cardEl.draggable = true;
            cardEl.dataset.cardId = card.id;
            
            cardEl.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <p class="font-medium text-gray-800 break-all">${card.serial}</p>
                    <button class="delete-card-btn text-gray-400 hover:text-red-500" data-card-id="${card.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="space-y-2 mt-3">
                     <div class="h-2 bg-gray-200 rounded-full w-10/12"></div>
                     <div class="h-2 bg-gray-200 rounded-full w-8/12"></div>
                </div>
                <div class="flex justify-between items-end mt-4">
                    <p class="text-sm text-gray-500 mt-1 break-all w-3/4">${card.notes || 'No Notes'}</p>
                    <div class="h-8 w-8 bg-gray-300 rounded-full flex-shrink-0"></div>
                </div>
            `;
            return cardEl;
        }
        
        // --- NEW: Render Chat ---
        function renderChat() {
            chatMessages.innerHTML = '';
            // Render in reverse so they appear from the bottom up
            [...state.chat].reverse().forEach(msg => {
                const msgEl = document.createElement('div');
                msgEl.textContent = msg.text;
                if (msg.peerId === myPeerId) {
                    msgEl.className = 'my-message';
                } else {
                    msgEl.className = 'peer-message';
                    msgEl.innerHTML = `<strong class="block text-xs">${msg.peerId.slice(0, 6)}...</strong> ${msg.text}`;
                }
                chatMessages.appendChild(msgEl);
            });
        }

        /**
         * Attaches all click and drag listeners to the board.
         */
        function attachEventListeners() {
            // --- Click Listeners ---
            addCardBtn.onclick = handleAddCardClick;
            mobileAddCardBtn.onclick = handleAddCardClick;
            
            // Add Section Button (might be one of two)
            const addSectionBtn = document.getElementById('add-section-btn');
            if (addSectionBtn) addSectionBtn.onclick = handleAddSectionClick;
            
            document.querySelectorAll('.delete-section-btn').forEach(btn => btn.onclick = handleDeleteSectionClick);
            document.querySelectorAll('.delete-card-btn').forEach(btn => btn.onclick = handleDeleteCardClick);

            // --- Drag Listeners ---
            const cards = document.querySelectorAll('.kanban-card');
            const dropZones = document.querySelectorAll('.card-list');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
            });
            
            // --- Mobile Listeners ---
            mobileStagingToggle.onclick = () => {
                mobileStagingDrawer.classList.toggle('active');
            };
        }
        
        // --- MODIFIED: Renamed to reflect new role ---
        function saveAndRenderLocally() {
            saveState();
            renderAll();
        }
        
        // --- MODAL HANDLERS ---
        function showModal(title, contentHTML, onConfirmCallback) {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHTML;
            onModalConfirm = onConfirmCallback;
            
            modalContainer.classList.add('active');
            modalBackdrop.classList.add('active');
            
            const firstInput = modalContent.querySelector('input, textarea');
            if (firstInput) firstInput.focus();
            
            // Special case for QR scanner
            if (title === 'Join Session') {
                startQRScanner();
            }
        }
        
        function hideModal() {
            onModalConfirm = null;
            modalContainer.classList.remove('active');
            modalBackdrop.classList.remove('active');
            modalContent.innerHTML = '';
            
            // Stop scanner if it's running
            if (html5QrCode && html5QrCode.getState() === Html5Qrcode.SCANNING) {
                html5QrCode.stop().catch(err => console.error("Error stopping scanner:", err));
            }
        }
        
        modalCancelBtn.onclick = hideModal;
        modalConfirmBtn.onclick = () => {
            if (onModalConfirm) onModalConfirm();
        };

        // --- MODIFIED: CLICK HANDLERS (to broadcast actions) ---
        
        function handleAddCardClick() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                        <input type="text" id="modal-serial" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <input type="text" id="modal-notes" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <p id="modal-error" class="text-red-500 text-sm h-4"></p>
                </div>
            `;
            showModal('Add New Card', content, () => {
                const serial = document.getElementById('modal-serial').value;
                const notes = document.getElementById('modal-notes').value;
                const errorEl = document.getElementById('modal-error');
                
                if (serial) {
                    const newCard = {
                        id: `card-${Date.now()}`,
                        serial: serial,
                        notes: notes,
                        sectionId: 'staging',
                        order: state.cards.filter(c => c.sectionId === 'staging').length
                    };
                    
                    // Create action and broadcast
                    const action = { type: 'ADD_CARD', card: newCard };
                    handleAction(action); // Apply locally
                    broadcast(action); // Send to peers
                    
                    hideModal();
                } else {
                    errorEl.textContent = 'Serial Number is required.';
                    document.getElementById('modal-serial').focus();
                }
            });
        }
        
        function handleAddSectionClick() {
            // ... (Same color picker logic as before) ...
            const sectionColors = ['#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#6b7280', '#8b5cf6', '#ef4444'];
            let selectedColor = sectionColors[0]; 
            const colorSwatchesHTML = sectionColors.map((color, index) => `
                <div class="color-swatch ${index === 0 ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"></div>
            `).join('');

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Section Title</label>
                        <input type="text" id="modal-title-input" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Header Color</label>
                        <div class="flex space-x-2 mt-2 flex-wrap gap-2">
                            ${colorSwatchesHTML}
                        </div>
                    </div>
                    <p id="modal-error" class="text-red-500 text-sm h-4"></p>
                </div>
            `;
            
            showModal('Add New Section', content, () => {
                const title = document.getElementById('modal-title-input').value;
                const errorEl = document.getElementById('modal-error');
                
                if (title) {
                    const newSection = {
                        id: `sec-${Date.now()}`,
                        title: title,
                        color: selectedColor 
                    };
                    
                    const action = { type: 'ADD_SECTION', section: newSection };
                    handleAction(action);
                    broadcast(action);
                    
                    hideModal();
                } else {
                    errorEl.textContent = 'Title is required.';
                    document.getElementById('modal-title-input').focus();
                }
            });
            
            // Add listeners to swatches
            const swatches = modalContent.querySelectorAll('.color-swatch');
            swatches.forEach(swatch => {
                swatch.addEventListener('click', () => {
                    swatches.forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                    selectedColor = swatch.dataset.color;
                });
            });
        }
        
        function handleDeleteSectionClick(e) {
            const sectionId = e.currentTarget.dataset.sectionId;
            showModal(
                'Delete Section?',
                `<p>Are you sure you want to delete this section? All cards in it will be permanently lost.</p>`,
                () => {
                    const action = { type: 'DELETE_SECTION', sectionId: sectionId };
                    handleAction(action);
                    broadcast(action);
                    hideModal();
                }
            );
        }
        
        function handleDeleteCardClick(e) {
            e.stopPropagation();
            const cardId = e.currentTarget.dataset.cardId;
            showModal(
                'Delete Card?',
                `<p>Are you sure you want to delete this card?</p>`,
                () => {
                    const action = { type: 'DELETE_CARD', cardId: cardId };
                    handleAction(action);
                    broadcast(action);
                    hideModal();
                }
            );
        }

        // --- DRAG-N-DROP LOGIC ---
        let draggedCardId = null;
        let placeholder = null;

        function handleDragStart(e) {
            // ... (Same as before) ...
            const cardEl = e.target.closest('.kanban-card');
            if (!cardEl) return;
            draggedCardId = cardEl.dataset.cardId;
            setTimeout(() => cardEl.classList.add('dragging'), 0);
            
            placeholder = document.createElement('div');
            placeholder.className = 'drag-placeholder';
            placeholder.style.height = `${cardEl.offsetHeight}px`;
            
            const isStaging = cardEl.closest('#staging-area, #mobile-staging-drawer');
            if (isStaging) {
                placeholder.classList.add('staging-placeholder');
                placeholder.style.width = `${cardEl.offsetWidth}px`;
            } else {
                placeholder.classList.add('section-placeholder');
            }
        }

        function handleDragEnd(e) {
            // ... (Same as before) ...
            const cardEl = document.querySelector(`[data-card-id="${draggedCardId}"]`);
            if (cardEl) cardEl.classList.remove('dragging');
            if (placeholder && placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }
            placeholder = null;
            draggedCardId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.card-list');
            if (!dropZone || !placeholder) return;
            
            // MODIFIED: Check for horizontal zones
            const isHorizontal = dropZone.id === 'staging-area' || dropZone.id === 'mobile-staging-drawer';
            if (isHorizontal) {
                handleDragOverHorizontal(e, dropZone);
            } else {
                handleDragOverVertical(e, dropZone);
            }
        }
        
        function handleDragOverVertical(e, dropZone) {
            const afterElement = getDragAfterElementVertical(dropZone, e.clientY);
            if (afterElement == null) {
                dropZone.appendChild(placeholder);
            } else {
                dropZone.insertBefore(placeholder, afterElement);
            }
        }

        function handleDragOverHorizontal(e, dropZone) {
            const afterElement = getDragAfterElementHorizontal(dropZone, e.clientX);
            if (afterElement == null) {
                dropZone.appendChild(placeholder);
            } else {
                dropZone.insertBefore(placeholder, afterElement);
            }
        }

        // MODIFIED: handleDrop to broadcast
        function handleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.card-list');
            if (!dropZone || !draggedCardId) return;
            
            const newSectionId = dropZone.dataset.sectionId; 

            // Find new order index
            const cardsInList = Array.from(dropZone.children);
            if (!dropZone.contains(placeholder)) {
                 dropZone.appendChild(placeholder);
            }
            const newIndex = cardsInList.indexOf(placeholder);

            // Create and send action
            const action = {
                type: 'MOVE_CARD',
                cardId: draggedCardId,
                newSectionId: newSectionId,
                newIndex: newIndex
            };
            handleAction(action);
            broadcast(action);
        }

        function getDragAfterElementVertical(container, y) {
            // ... (Same as before) ...
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function getDragAfterElementHorizontal(container, x) {
            // ... (Same as before) ...
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // --- ADDED: Action Handler ---
        /**
         * The single source of truth for modifying state.
         * All local actions and received peer actions come through here.
         */
        function handleAction(action) {
            console.log('Handling action:', action);
            
            switch(action.type) {
                case 'ADD_CARD':
                    state.cards.push(action.card);
                    break;
                
                case 'ADD_SECTION':
                    state.sections.push(action.section);
                    break;
                
                case 'DELETE_SECTION':
                    state.sections = state.sections.filter(s => s.id !== action.sectionId);
                    state.cards = state.cards.filter(c => c.sectionId !== action.sectionId);
                    break;
                    
                case 'DELETE_CARD':
                    state.cards = state.cards.filter(c => c.id !== action.cardId);
                    break;
                    
                case 'MOVE_CARD':
                    const card = state.cards.find(c => c.id === action.cardId);
                    if (!card) return;
                    
                    card.sectionId = action.newSectionId;
                    
                    let otherCards = state.cards
                        .filter(c => c.sectionId === action.newSectionId && c.id !== action.cardId)
                        .sort((a,b) => a.order - b.order);
                
                    otherCards.splice(action.newIndex, 0, card);
                    otherCards.forEach((c, index) => c.order = index);
                    break;
                
                case 'CHAT_MESSAGE':
                    state.chat.push(action.message);
                    renderChat();
                    // Don't saveAndRender, just update chat
                    // If message is not from me, bounce
                    if (action.message.peerId !== myPeerId) {
                        chatFab.classList.add('bouncing');
                        setTimeout(() => chatFab.classList.remove('bouncing'), 1200);
                    }
                    return; // Don't re-render whole board for chat
            }
            
            // Re-render and save
            saveAndRenderLocally();
        }

        // --- IMPORT / EXPORT LOGIC ---
        if (saveBtn) saveBtn.onclick = handleSaveFile;
        if (loadBtn) loadBtn.onclick = () => fileInput.click();
        if (fileInput) fileInput.onchange = handleLoadFile;

        function handleSaveFile() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `decom_board_${new Date().toISOString().split('T')[0]}.mim`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function handleLoadFile(e) {
            const file = e.target.files[0];
            if (file) loadMimFile(file);
            e.target.value = null;
        }

        // ... (Drag-n-drop file load logic remains the same) ...
        window.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (e.dataTransfer.items && e.dataTransfer.items.length > 0 && e.dataTransfer.items[0].kind === 'file') {
                dropZone.classList.add('active');
            }
        });
        dropZone.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null || !dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('active');
            }
        });
        dropZone.addEventListener('dragover', (e) => e.preventDefault());
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.name.endsWith('.mim')) loadMimFile(file);
                else alert('Not a .mim file!');
            }
        });
        
        function loadMimFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const newState = JSON.parse(event.target.result);
                    if (newState && newState.sections && newState.cards) {
                        state = newState;
                        if (!state.chat) state.chat = []; // Ensure chat exists
                        saveAndRenderLocally();
                        // If host, broadcast new state to all
                        if (isHost) {
                            broadcast({ type: 'FULL_STATE', payload: state });
                        }
                    } else throw new Error('Invalid file format');
                } catch (err) {
                    console.error('Error loading .mim file:', err);
                    alert('Could not load .mim file.');
                }
            };
            reader.readAsText(file);
        }
        
        // --- ADDED: PEERJS & CHAT LOGIC ---
        
        function setConnectionStatus(status) {
            connectionStatus.textContent = status;
            mobileConnectionStatus.textContent = status;
            if (status === 'Offline') {
                connectionStatus.className = 'text-sm text-gray-500';
                mobileConnectionStatus.className = 'absolute top-5 left-4 text-sm text-gray-500 z-50';
            } else if (status.startsWith('Connected')) {
                connectionStatus.className = 'text-sm text-green-600 font-medium';
                mobileConnectionStatus.className = 'absolute top-5 left-4 text-sm text-green-600 font-medium z-50';
            } else {
                connectionStatus.className = 'text-sm text-yellow-600';
                mobileConnectionStatus.className = 'absolute top-5 left-4 text-sm text-yellow-600 z-50';
            }
        }
        
        // Host starts a session
        startSessionBtn.onclick = () => {
            isHost = true;
            peer = new Peer(`decom-board-host-${Date.now()}`); // Unique ID
            
            peer.on('open', (id) => {
                myPeerId = id;
                setConnectionStatus('Waiting for peers...');
                console.log('PeerJS Host ID:', id);
                
                // Show QR code modal
                const content = `
                    <p class="text-center">Scan this QR code with your mobile device to join.</p>
                    <canvas id="qr-canvas" class="mx-auto my-4"></canvas>
                    <p class="text-center text-sm text-gray-500">Or manually enter ID:</p>
                    <input type="text" class="w-full bg-gray-100 text-center text-gray-700 p-2 rounded" value="${id}" readonly>
                `;
                showModal('Session Started', content, hideModal);
                
                const canvas = document.getElementById('qr-canvas');
                QRCode.toCanvas(canvas, id, (error) => {
                    if (error) console.error(error);
                });
            });
            
            peer.on('connection', (conn) => {
                console.log('Peer connected:', conn.peer);
                connections.push(conn);
                setConnectionStatus(`Connected (${connections.length} peer${connections.length > 1 ? 's' : ''})`);
                chatFab.style.display = 'flex';
                
                conn.on('open', () => {
                    // Send the new peer the FULL current state
                    conn.send({ type: 'FULL_STATE', payload: state });
                });
                
                conn.on('data', (data) => {
                    console.log('Host received data:', data);
                    // Host is authoritative. Apply action and broadcast to ALL.
                    handleAction(data);
                    broadcast(data); // Echo back to all clients (including sender)
                });
                
                conn.on('close', () => {
                    connections = connections.filter(c => c.peer !== conn.peer);
                    setConnectionStatus(connections.length > 0 ? `Connected (${connections.length} peer${connections.length > 1 ? 's' : ''})` : 'Waiting for peers...');
                });
            });
            
            peer.on('error', (err) => console.error('PeerJS Host Error:', err));
        };
        
        // Client joins a session (generic function)
        function joinSession() {
            const content = `
                <p class="mb-4">Scan the QR code from the host's screen.</p>
                <div id="qr-reader"></div>
                <p class="text-center text-gray-500 my-2">OR</p>
                <label class="font-medium">Enter Host ID</label>
                <input type="text" id="manual-peer-id" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2">
            `;
            showModal('Join Session', content, () => {
                // Confirm button logic (for manual entry)
                const manualId = document.getElementById('manual-peer-id').value;
                if (manualId) {
                    connectToHost(manualId);
                    hideModal();
                } else {
                    alert('Please scan a code or enter an ID.');
                }
            });
        }
        
        joinSessionBtnDesktop.onclick = joinSession;
        mobileJoinBtn.onclick = joinSession;
        
        function startQRScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText, decodedResult) => {
                    // Success
                    console.log(`QR Scanned: ${decodedText}`);
                    html5QrCode.stop();
                    hideModal();
                    connectToHost(decodedText);
                },
                (errorMessage) => { /* console.log(errorMessage); */ } // Ignore errors
            ).catch((err) => {
                console.error("Cannot start QR scanner:", err);
                modalContent.innerHTML += `<p class="text-red-500">Could not start camera. Check permissions.</p>`;
            });
        }
        
        // Client connects to host
        function connectToHost(hostId) {
            if (peer) peer.destroy(); // Ensure old peer is gone
            
            peer = new Peer();
            isHost = false;
            
            peer.on('open', (id) => {
                myPeerId = id;
                console.log('Client Peer ID:', id, 'connecting to', hostId);
                setConnectionStatus('Connecting...');
                
                const conn = peer.connect(hostId);
                connections = [conn]; // Client only has one connection (to host)
                
                conn.on('open', () => {
                    console.log('Connected to host!');
                    setConnectionStatus('Connected (Client)');
                    chatFab.style.display = 'flex';
                });
                
                conn.on('data', (data) => {
                    console.log('Client received data:', data);
                    if (data.type === 'FULL_STATE') {
                        state = data.payload;
                        saveAndRenderLocally();
                    } else {
                        // Apply action received from host
                        handleAction(data);
                    }
                });
                
                conn.on('close', () => {
                    setConnectionStatus('Offline (Disconnected)');
                    chatFab.style.display = 'none';
                    connections = [];
                });
            });
            
            peer.on('error', (err) => console.error('PeerJS Client Error:', err));
        }
        
        // Broadcast data to all connections
        function broadcast(data) {
            connections.forEach(conn => {
                if (conn && conn.open) {
                    conn.send(data);
                }
            });
        }
        
        // Chat UI Logic
        chatFab.onclick = () => {
            chatWindow.classList.toggle('active');
            chatFab.classList.remove('bouncing'); // Stop bouncing on open
        };
        
        function sendChat() {
            const text = chatInput.value;
            if (text.trim() === '') return;
            
            const message = {
                peerId: myPeerId,
                text: text
            };
            
            const action = { type: 'CHAT_MESSAGE', message: message };
            
            handleAction(action); // Apply locally
            broadcast(action); // Send to peers
            
            chatInput.value = '';
        }
        
        chatSendBtn.onclick = sendChat;
        chatInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                sendChat();
            }
        };

        // --- INITIALIZATION ---
        loadState();
        renderAll();
        
        // Re-render on resize to switch between mobile/desktop
        window.onresize = renderAll;
        
    </script>
</body>
</html>
