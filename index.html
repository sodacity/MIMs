<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decom Board</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. PeerJS for real-time sync -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <!-- 3. QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- 4. QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- 5. NEW: Quill Rich Text Editor (JS) -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <!-- 6. NEW: Quill Rich Text Editor (CSS) -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    
    <script>
        // 7. Configure Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'kanban-bg': '#3498db',
                        'kanban-section-body': '#f3f4f6',
                        'kanban-card': '#ffffff',
                        'kanban-footer': '#ffffff',
                    }
                }
            }
        }
    </script>
    <!-- 8. Get the "Inter" font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 9. All our custom styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        /* Style for the card being dragged */
        .dragging {
            opacity: 0.8;
            transform: rotate(2deg);
        }
        /* Style for the placeholder where the card will drop */
        .drag-placeholder {
            background: rgba(0, 0, 0, 0.05);
            border: 2px dashed #4f46e5;
            border-radius: 0.5rem;
            flex-shrink: 0;
        }
        .section-placeholder {
            width: 100%;
            margin: 0.5rem 0;
        }
        .staging-placeholder {
            margin: 0 0.5rem;
        }
        /* NEW: Placeholder for dragging SECTIONS */
        .section-drag-placeholder {
            background: rgba(0, 0, 0, 0.1);
            border: 2px dashed #4f46e5;
            border-radius: 0.5rem;
            flex-shrink: 0;
            width: 320px; /* 80w */
            height: 100%;
        }
        .dragging-section {
             opacity: 0.5;
             transform: scale(1.02);
        }
        /* Hide the native file input */
        #file-input { display: none; }
        /* File-drop overlay */
        #drop-zone {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: none;
            align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(5px);
            border: 4px dashed #4f46e5;
        }
        #drop-zone.active { display: flex; }
        
        /* Modal Styles */
        #modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 1000; display: none;
        }
        #modal-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 1001;
            display: none; width: 90%; max-width: 500px;
            background-color: #ffffff; color: #111827;
        }
        /* NEW: Larger modal for editor */
        #modal-container.modal-lg {
            max-width: 800px;
        }
        #modal-container.active,
        #modal-backdrop.active { display: block; }
        
        /* Custom scrollbar */
        .horizontal-scroll {
            scrollbar-color: #4f46e5 #d1d5db; scrollbar-width: thin;
        }
        .horizontal-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .horizontal-scroll::-webkit-scrollbar-track { background: #d1d5db; border-radius: 10px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #4f46e5; border-radius: 10px; }

        /* Color swatches */
        .color-swatch {
            width: 2rem; height: 2rem; border-radius: 9999px;
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
        }
        .color-swatch.selected, .color-swatch:hover {
            border-color: #111827; transform: scale(1.1);
        }

        /* --- Mobile & Chat Styles --- */
        #desktop-ui { display: flex; flex-direction: column; height: 100vh; }
        #mobile-ui { display: none; }
        @media (max-width: 768px) {
            #desktop-ui { display: none; }
            #mobile-ui {
                display: flex; flex-direction: column; height: 100vh;
                overflow: hidden; background-color: #f3f4f6;
            }
            #mobile-swiper {
                flex: 1; display: flex; overflow-x: auto;
                scroll-snap-type: x mandatory; scrollbar-width: none; -ms-overflow-style: none;
            }
            #mobile-swiper::-webkit-scrollbar { display: none; }
            #mobile-swiper > .kanban-section {
                flex: 0 0 100%; scroll-snap-align: center; height: 100%;
                margin: 0; border-radius: 0; box-shadow: none; border: none;
            }
            #mobile-staging-toggle {
                flex-shrink: 0; background-color: #ffffff; border-top: 1px solid #d1d5db;
                padding: 1rem; font-weight: 600; text-align: center; cursor: pointer;
            }
            #mobile-staging-drawer {
                flex-shrink: 0; background-color: #e5e7eb; height: 200px;
                overflow-x: auto; display: none; align-items: center;
                padding: 1rem; gap: 1rem;
            }
            #mobile-staging-drawer.active { display: flex; }
            #mobile-add-card-btn { height: 100%; min-width: 150px; }
        }
        
        /* Chat Bubble */
        #chat-fab {
            position: fixed; bottom: 20px; right: 20px; background-color: #4f46e5; color: white;
            width: 60px; height: 60px; border-radius: 50%; display: none; align-items: center;
            justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 990;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #chat-fab.bouncing { animation: bounce 0.6s 2; }
        
        /* Chat Window */
        #chat-window {
            position: fixed; bottom: 90px; right: 20px; width: 350px; height: 450px; background: white;
            border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); z-index: 989;
            display: none; flex-direction: column; overflow: hidden;
        }
        #chat-window.active { display: flex; }
        #chat-messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        #chat-messages div { margin-bottom: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 12px; max-width: 80%; }
        #chat-messages .my-message { background-color: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        #chat-messages .peer-message { background-color: #e5e7eb; color: #111827; align-self: flex-start; border-bottom-left-radius: 0; }
        #chat-input-area { display: flex; border-top: 1px solid #e5e7eb; padding: 0.5rem; }
        #chat-input { flex: 1; border: 1px solid #d1d5db; border-radius: 99px; padding: 0.5rem 1rem; margin-right: 0.5rem; }
        #chat-send-btn { background-color: #4f46e5; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; flex-shrink: 0; }
        
        /* QR Code Scanner */
        #qr-reader { width: 100%; border: 2px dashed #4f46e5; border-radius: 8px; }

        /* NEW: Quill Editor Styles */
        #quill-editor {
            height: 300px; /* Give the editor a set height */
            background-color: #f9fafb;
            color: #111827;
        }
        /* Ensure Quill tooltips are above the modal */
        .ql-tooltip { z-index: 1005; }
        .ql-snow .ql-editor img { max-width: 100%; height: auto; }

        /* NEW: Desktop Layout Toggle Styles */
        #board-container.desktop-vertical {
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            gap: 1.5rem; /* 24px */
        }
        #board-container.desktop-vertical > .kanban-section {
            width: 98%; /* A bit of padding */
            margin: 0 auto;
            height: auto; /* Auto-height for vertical stack */
        }
        
        #layout-toggle-btns button {
            display: none; /* Hide by default */
        }
        /* Show only on desktop */
        @media (min-width: 769px) {
            #layout-toggle-btns button {
                display: inline-flex;
            }
        }

    </style>
</head>
<body class="bg-kanban-bg text-gray-900 h-screen flex flex-col">

    <!-- =========== DESKTOP UI =========== -->
    <div id="desktop-ui">
        <!-- KANBAN BOARD -->
        <!-- MODIFIED: Added default class -->
        <main id="board-container" class="flex-1 flex gap-6 p-6 overflow-x-auto horizontal-scroll desktop-horizontal">
            <!-- Sections and cards will be dynamically generated here -->
        </main>
        
        <!-- STAGING AREA FOOTER -->
        <footer class="flex-shrink-0 bg-kanban-footer border-t border-gray-200 shadow-inner">
            <div class="flex justify-between items-center px-6 pt-4">
                <div class="flex items-center space-x-4">
                    <h2 class="text-lg font-semibold text-gray-700">Staging Area</h2>
                    <button id="start-session-btn" class="px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-500 transition-all">Start Session</button>
                    <button id="join-session-btn-desktop" class="px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-500 transition-all">Join Session</button>
                    <div id="connection-status" class="text-sm text-gray-500">Offline</div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- NEW: Layout Toggles -->
                    <div id="layout-toggle-btns" class="flex items-center space-x-2 mr-4">
                        <button id="layout-horizontal-btn" title="Stack Horizontally" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="16" y2="21"></line></svg>
                        </button>
                        <button id="layout-vertical-btn" title="Stack Vertically" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="8" x2="21" y2="8"></line><line x1="3" y1="16" x2="21" y2="16"></line></svg>
                        </button>
                    </div>

                    <button id="save-btn" title="Save as .mim backup" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <button id="load-btn" title="Load from .mim file" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L9 7.586V15a1 1 0 11-2 0V7.586L5.707 8.707a1 1 0 01-1.414-1.414l3-3z" clip-rule="evenodd" /></svg>
                    </button>
                    <input type="file" id="file-input" accept=".mim">
                </div>
            </div>

            <div id="staging-area" class="card-list flex items-center gap-4 p-6 pt-4 overflow-x-auto horizontal-scroll" data-section-id="staging">
                <button id="add-card-btn" class="w-64 h-24 flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                    + Add New Card
                </button>
            </div>
        </footer>
    </div>
    
    <!-- =========== MOBILE UI =========== -->
    <div id="mobile-ui">
        <!-- Mobile Section Swiper -->
        <main id="mobile-swiper">
            <!-- Mobile sections injected here -->
        </main>
        
        <!-- Mobile Staging Area -->
        <footer class="flex-shrink-0">
            <div id="mobile-staging-toggle">Staging Area</div>
            <div id="mobile-staging-drawer" class="card-list" data-section-id="staging">
                <button id="mobile-add-card-btn" class="w-40 h-full flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-600 rounded-lg">
                    + Add Card
                </button>
                <!-- Mobile staging cards injected here -->
            </div>
        </footer>

        <!-- ADDED: Mobile "Join Session" button -->
        <button id="join-session-btn-mobile" class="absolute top-4 right-4 px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-500 transition-all z-50">
            Join
        </button>
        <div id="mobile-connection-status" class="absolute top-5 left-4 text-sm text-gray-500 z-50">Offline</div>
    </div>

    <!-- =========== SHARED UI (Modals, Chat, etc) =========== -->

    <!-- FILE DROP OVERLAY -->
    <div id="drop-zone" class="text-white text-2xl font-bold"><p>Drop .mim file to load</p></div>
    
    <!-- MODAL UI -->
    <div id="modal-backdrop"></div>
    <div id="modal-container" class="bg-white rounded-lg shadow-2xl overflow-hidden">
        <div class="p-6">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-900 mb-6">Modal Title</h2>
            <div id="modal-content" class="text-gray-700">
                <!-- Modal content injected here -->
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-all">Cancel</button>
            <button id="modal-confirm-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-500 transition-all">Confirm</button>
        </div>
    </div>

    <!-- CHAT UI -->
    <div id="chat-fab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </div>
    <div id="chat-window">
        <div class="p-4 border-b font-semibold">Chat</div>
        <div id="chat-messages"><div class="peer-message" style="align-self: center; background: #f9fafb; color: #6b7280;">Session started...</div></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="chat-send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 m-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const boardContainer = document.getElementById('board-container');
        const stagingArea = document.getElementById('staging-area');
        const addCardBtn = document.getElementById('add-card-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        
        // --- Mobile UI ---
        const mobileSwiper = document.getElementById('mobile-swiper');
        const mobileStagingToggle = document.getElementById('mobile-staging-toggle');
        const mobileStagingDrawer = document.getElementById('mobile-staging-drawer');
        const mobileAddCardBtn = document.getElementById('mobile-add-card-btn');
        const mobileJoinBtn = document.getElementById('join-session-btn-mobile');
        const mobileConnectionStatus = document.getElementById('mobile-connection-status');
        
        // --- Collaboration UI ---
        const startSessionBtn = document.getElementById('start-session-btn');
        const joinSessionBtnDesktop = document.getElementById('join-session-btn-desktop');
        const connectionStatus = document.getElementById('connection-status');
        const chatFab = document.getElementById('chat-fab');
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        
        // --- NEW: Layout Toggles ---
        const layoutHorizontalBtn = document.getElementById('layout-horizontal-btn');
        const layoutVerticalBtn = document.getElementById('layout-vertical-btn');

        let state = {
            sections: [],
            cards: [],
            chat: [],
            desktopLayout: 'horizontal' // NEW
        };
        
        let onModalConfirm = null;
        let quillEditor = null; // NEW: Store Quill instance
        
        // --- PeerJS variables ---
        let peer = null;
        let myPeerId = null;
        let isHost = false;
        let connections = [];
        let html5QrCode = null;
        
        // --- CORE FUNCTIONS ---
        function saveState() {
            localStorage.setItem('decomBoardState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('decomBoardState');
            if (savedState) {
                state = JSON.parse(savedState);
                if (!state.chat) state.chat = [];
                if (!state.desktopLayout) state.desktopLayout = 'horizontal';
                
                // Data migration
                let migrated = false;
                state.cards.forEach(card => {
                    if (card.hasOwnProperty('serial')) {
                        card.title = card.serial;
                        delete card.serial;
                        migrated = true;
                    }
                    if (card.hasOwnProperty('assetTag')) {
                        card.notes = card.assetTag;
                        delete card.assetTag;
                        migrated = true;
                    }
                });
                if (migrated) {
                    console.log("Data migrated: serial -> title, assetTag -> notes");
                    saveState();
                }

            } else {
                state = {
                    sections: [
                        { id: `sec-${Date.now()}`, title: "Backlog", color: "#ec4899", order: 0 },
                        { id: `sec-${Date.now() + 1}`, title: "Doing", color: "#f59e0b", order: 1 },
                        { id: `sec-${Date.now() + 2}`, title: "Done", color: "#10b981", order: 2 }
                    ],
                    cards: [],
                    chat: [],
                    desktopLayout: 'horizontal'
                };
            }
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                renderMobileUI();
            } else {
                renderDesktopUI();
            }
            renderChat();
            attachEventListeners();
        }
        
        function renderDesktopUI() {
            boardContainer.innerHTML = '';
            
            // NEW: Apply layout class
            boardContainer.className = 'flex-1 flex gap-6 p-6 overflow-x-auto horizontal-scroll'; // Reset
            if (state.desktopLayout === 'vertical') {
                boardContainer.classList.add('desktop-vertical');
                boardContainer.classList.remove('desktop-horizontal', 'overflow-x-auto');
            } else {
                boardContainer.classList.add('desktop-horizontal');
                boardContainer.classList.remove('desktop-vertical', 'overflow-y-auto');
            }

            // Render sections in order
            state.sections
                .sort((a, b) => a.order - b.order)
                .forEach(section => {
                    const sectionEl = createSectionElement(section);
                    const cardList = sectionEl.querySelector('.card-list');
                    const sectionCards = state.cards
                        .filter(card => card.sectionId === section.id)
                        .sort((a, b) => a.order - b.order);

                    sectionCards.forEach(card => {
                        const cardEl = createCardElement(card);
                        cardList.appendChild(cardEl);
                    });
                    
                    boardContainer.appendChild(sectionEl);
            });
            
            boardContainer.appendChild(createAddSectionButton());
            
            // Render Staging Area
            stagingArea.innerHTML = '';
            const stagingCards = state.cards
                .filter(card => card.sectionId === 'staging')
                .sort((a, b) => a.order - b.order);

            stagingCards.forEach(card => {
                const cardEl = createCardElement(card);
                stagingArea.appendChild(cardEl);
            });
            stagingArea.appendChild(addCardBtn);
        }
        
        function renderMobileUI() {
            mobileSwiper.innerHTML = ''; // Clear swiper
            
            state.sections
                .sort((a, b) => a.order - b.order) // Use order for mobile too
                .forEach(section => {
                    const sectionEl = createSectionElement(section);
                    const cardList = sectionEl.querySelector('.card-list');
                    const sectionCards = state.cards
                        .filter(card => card.sectionId === section.id)
                        .sort((a, b) => a.order - b.order);

                    sectionCards.forEach(card => {
                        const cardEl = createCardElement(card);
                        cardList.appendChild(cardEl);
                    });
                    mobileSwiper.appendChild(sectionEl);
            });
            
            mobileSwiper.appendChild(createAddSectionButton());
            
            // Render Staging Drawer
            mobileStagingDrawer.innerHTML = '';
            const stagingCards = state.cards
                .filter(card => card.sectionId === 'staging')
                .sort((a, b) => a.order - b.order);

            stagingCards.forEach(card => {
                const cardEl = createCardElement(card);
                mobileStagingDrawer.appendChild(cardEl);
            });
            mobileStagingDrawer.appendChild(mobileAddCardBtn);
        }
        
        function createSectionElement(section) {
            const sectionEl = document.createElement('div');
            // MODIFIED: Added draggable=true for the element
            sectionEl.className = 'kanban-section w-80 rounded-lg shadow-xl flex flex-col flex-shrink-0 overflow-hidden';
            sectionEl.dataset.sectionId = section.id;
            sectionEl.draggable = true; // NEW: Make the section draggable
            
            const headerColor = section.color || '#6b7280';
            const headerTextColor = '#ffffff';

            sectionEl.innerHTML = `
                <div class="kanban-section-header p-4 flex justify-between items-center cursor-grab active:cursor-grabbing" style="background-color: ${headerColor}; color: ${headerTextColor};">
                    <h2 class="font-semibold text-lg">${section.title}</h2>
                    <button class="delete-section-btn hover:text-gray-300" data-section-id="${section.id}" style="color: ${headerTextColor};">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="card-list flex-1 p-4 space-y-4 overflow-y-auto horizontal-scroll bg-kanban-section-body" data-section-id="${section.id}">
                    <!-- Cards go here -->
                </div>
            `;
            return sectionEl;
        }
        
        function createAddSectionButton() {
            const addSectionBtnEl = document.createElement('button');
            addSectionBtnEl.id = 'add-section-btn';
            addSectionBtnEl.className = 'w-80 h-24 flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200/50 text-gray-600 rounded-lg hover:bg-gray-200 hover:text-gray-800 transition-all border-2 border-dashed border-gray-400';
            addSectionBtnEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 0V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2z" />
                </svg>
                + Add New Section
            `;
            // NEW: Add a class for vertical layout
            if(state.desktopLayout === 'vertical') {
                addSectionBtnEl.classList.add('w-full', 'mx-auto', 'max-w-7xl');
            }
            return addSectionBtnEl;
        }

        /**
         * MODIFIED: Creates the new fixed-height card element.
         */
        function createCardElement(card) {
            const cardEl = document.createElement('div');
            const isStaging = card.sectionId === 'staging';
            const cardWidthClass = isStaging ? 'w-64' : 'w-full';

            // MODIFIED: Removed cursor-grab, whole card is now a button
            cardEl.className = `kanban-card p-4 bg-kanban-card text-gray-900 rounded-md shadow hover:shadow-lg transition-all ${cardWidthClass} flex-shrink-0`;
            cardEl.dataset.cardId = card.id;
            
            // Check for notes or images
            const hasNotes = card.notes && card.notes.trim() !== '' && card.notes.trim() !== '<p><br></p>';
            const hasImages = card.notes && card.notes.includes('<img');

            cardEl.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <p class="font-medium text-gray-800 break-all">${card.title}</p>
                    <button class="delete-card-btn text-gray-400 hover:text-red-500 z-10" data-card-id="${card.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <!-- Placeholder content removed -->

                <div class="flex justify-between items-end mt-4">
                    <div class="flex space-x-2">
                        ${hasNotes ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>` : ''}
                        ${hasImages ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01" /></svg>` : ''}
                    </div>
                    <div class="h-8 w-8 bg-gray-300 rounded-full flex-shrink-0"></div>
                </div>
                
                <!-- NEW: Draggable handle for staging area, and click listener for everywhere -->
                <div class="absolute inset-0 cursor-pointer" data-action="edit"></div>
                ${isStaging ? `<div class="absolute inset-0 cursor-grab" data-action="drag" draggable="true"></div>` : ''}
            `;
            
            // NEW: Add specific event listeners
            const dragHandle = cardEl.querySelector('[data-action="drag"]');
            const editHandle = cardEl.querySelector('[data-action="edit"]');
            
            if (isStaging && dragHandle) {
                // In staging, only the drag handle is draggable
                dragHandle.addEventListener('dragstart', handleDragStart);
                dragHandle.addEventListener('dragend', handleDragEnd);
            } else if (!isStaging) {
                // In sections, the whole card is draggable
                cardEl.draggable = true;
                cardEl.addEventListener('dragstart', handleDragStart);
                cardEl.addEventListener('dragend', handleDragEnd);
            }

            editHandle.addEventListener('click', handleEditCardClick);

            return cardEl;
        }
        
        function renderChat() { /* ... (no changes) ... */ }

        function attachEventListeners() {
            // Click Listeners
            addCardBtn.onclick = handleAddCardClick;
            mobileAddCardBtn.onclick = handleAddCardClick;
            
            const addSectionBtn = document.getElementById('add-section-btn');
            if (addSectionBtn) addSectionBtn.onclick = handleAddSectionClick;
            
            document.querySelectorAll('.delete-section-btn').forEach(btn => btn.onclick = handleDeleteSectionClick);
            // Delete card buttons are attached in createCardElement
            
            // Drag Listeners (CARDS)
            // MODIFIED: Card listeners are attached in createCardElement
            const dropZones = document.querySelectorAll('.card-list');
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
            });

            // NEW: Drag Listeners (SECTIONS)
            const sections = document.querySelectorAll('.kanban-section');
            const board = document.getElementById('board-container');
            sections.forEach(section => {
                section.addEventListener('dragstart', handleSectionDragStart);
                section.addEventListener('dragend', handleSectionDragEnd);
            });
            board.addEventListener('dragover', handleSectionDragOver);
            board.addEventListener('drop', handleSectionDrop);

            // Mobile Listeners
            mobileStagingToggle.onclick = () => {
                mobileStagingDrawer.classList.toggle('active');
            };
            
            // NEW: Layout Toggle Listeners
            layoutHorizontalBtn.onclick = () => {
                state.desktopLayout = 'horizontal';
                saveAndRenderLocally();
            };
            layoutVerticalBtn.onclick = () => {
                state.desktopLayout = 'vertical';
                saveAndRenderLocally();
            };
        }
        
        function saveAndRenderLocally() {
            saveState();
            renderAll();
        }
        
        // --- MODAL HANDLERS ---
        function showModal(title, contentHTML, onConfirmCallback, modalSize = 'md') {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHTML;
            onModalConfirm = onConfirmCallback;
            
            // NEW: Handle modal size
            if (modalSize === 'lg') {
                modalContainer.classList.add('modal-lg');
            } else {
                modalContainer.classList.remove('modal-lg');
            }
            
            modalContainer.classList.add('active');
            modalBackdrop.classList.add('active');
            
            const firstInput = modalContent.querySelector('input, textarea');
            if (firstInput) firstInput.focus();
            
            if (title === 'Join Session') startQRScanner();
        }
        
        function hideModal() {
            onModalConfirm = null;
            if (quillEditor) quillEditor = null; // NEW: Clear Quill instance
            modalContainer.classList.remove('active', 'modal-lg');
            modalBackdrop.classList.remove('active');
            modalContent.innerHTML = '';
            
            if (html5QrCode && html5QrCode.getState() === Html5Qrcode.SCANNING) {
                html5QrCode.stop().catch(err => console.error("Error stopping scanner:", err));
            }
        }
        
        modalCancelBtn.onclick = hideModal;
        modalConfirmBtn.onclick = () => {
            if (onModalConfirm) onModalConfirm();
        };

        // --- CLICK HANDLERS ---
        
        // MODIFIED: Simplified to only ask for Title
        function handleAddCardClick() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="modal-title" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <p id="modal-error" class="text-red-500 text-sm h-4"></p>
                </div>
            `;
            showModal('Add New Card', content, () => {
                const title = document.getElementById('modal-title').value;
                const errorEl = document.getElementById('modal-error');
                
                if (title) {
                    const newCard = {
                        id: `card-${Date.now()}`,
                        title: title,
                        notes: '', // Start with empty notes
                        sectionId: 'staging',
                        order: state.cards.filter(c => c.sectionId === 'staging').length
                    };
                    
                    const action = { type: 'ADD_CARD', card: newCard };
                    submitAction(action);
                    hideModal();
                } else {
                    errorEl.textContent = 'Title is required.';
                    document.getElementById('modal-title').focus();
                }
            });
        }
        
        // NEW: Handle clicking a card to edit it
        function handleEditCardClick(e) {
            e.stopPropagation();
            const cardEl = e.currentTarget.closest('.kanban-card');
            const cardId = cardEl.dataset.cardId;
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            const content = `
                <div id="quill-editor"></div>
                <p id="modal-error" class="text-red-500 text-sm h-4 mt-2"></p>
            `;
            
            showModal(`Edit Card: ${card.title}`, content, () => {
                // Confirm callback (Save)
                const notesContent = quillEditor.root.innerHTML;
                const updatedCard = { ...card, notes: notesContent };
                
                const action = { type: 'UPDATE_CARD', card: updatedCard };
                submitAction(action);
                hideModal();
            }, 'lg'); // NEW: Use large modal
            
            // Initialize Quill
            // Use setTimeout to ensure modal is visible before Quill init
            setTimeout(() => {
                try {
                    quillEditor = new Quill('#quill-editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{'list': 'ordered'}, {'list': 'bullet'}],
                                ['link', 'image', 'code-block'],
                                ['clean']
                            ]
                        }
                    });
                    
                    // NEW: Override image handler
                    quillEditor.getModule('toolbar').addHandler('image', () => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        
                        input.onchange = () => {
                            const file = input.files[0];
                            if (/^image\//.test(file.type)) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const range = quillEditor.getSelection(true);
                                    quillEditor.insertEmbed(range.index, 'image', e.target.result);
                                    quillEditor.setSelection(range.index + 1);
                                };
                                reader.readAsDataURL(file); // Convert to base64
                            } else {
                                console.warn('You can only upload images.');
                            }
                        };
                    });

                    // Load existing content
                    quillEditor.root.innerHTML = card.notes;
                } catch (err) {
                    console.error("Quill init failed:", err);
                    modalContent.innerHTML = "<p class='text-red-500'>Error loading editor.</p>";
                }
            }, 50);
        }
        
        function handleAddSectionClick() { /* ... (no changes, still works) ... */ }
        function handleDeleteSectionClick(e) { /* ... (no changes, still works) ... */ }
        function handleDeleteCardClick(e) { /* ... (no changes, still works) ... */ }

        // --- CARD DRAG-N-DROP LOGIC ---
        let draggedCardId = null;
        let placeholder = null;

        function handleDragStart(e) {
            const cardEl = e.currentTarget.closest('.kanban-card');
            draggedCardId = cardEl.dataset.cardId;
            setTimeout(() => cardEl.classList.add('dragging'), 0);
            
            placeholder = document.createElement('div');
            placeholder.className = 'drag-placeholder';
            placeholder.style.height = `${cardEl.offsetHeight}px`;
            
            const isStaging = cardEl.closest('#staging-area, #mobile-staging-drawer');
            if (isStaging) {
                placeholder.classList.add('staging-placeholder');
                placeholder.style.width = `${cardEl.offsetWidth}px`;
            } else {
                placeholder.classList.add('section-placeholder');
            }
        }
        function handleDragEnd(e) {
            const cardEl = document.querySelector(`[data-card-id="${draggedCardId}"]`);
            if (cardEl) cardEl.classList.remove('dragging');
            if (placeholder && placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }
            placeholder = null;
            draggedCardId = null;
        }
        function handleDragOver(e) { /* ... (no changes) ... */ }
        function handleDragOverVertical(e, dropZone) { /* ... (no changes) ... */ }
        function handleDragOverHorizontal(e, dropZone) { /* ... (no changes) ... */ }
        function handleDrop(e) { /* ... (no changes) ... */ }
        function getDragAfterElementVertical(container, y) { /* ... (no changes) ... */ }
        function getDragAfterElementHorizontal(container, x) { /* ... (no changes) ... */ }
        
        // --- NEW: SECTION DRAG-N-DROP LOGIC ---
        let draggedSectionId = null;
        let sectionPlaceholder = null;
        
        function handleSectionDragStart(e) {
            // Only allow dragging by the header on desktop horizontal
            if (state.desktopLayout !== 'horizontal' || !e.target.classList.contains('kanban-section-header')) {
                e.preventDefault();
                return;
            }
            
            const sectionEl = e.currentTarget.closest('.kanban-section');
            draggedSectionId = sectionEl.dataset.sectionId;
            setTimeout(() => sectionEl.classList.add('dragging-section'), 0);
            
            sectionPlaceholder = document.createElement('div');
            sectionPlaceholder.className = 'section-drag-placeholder';
            sectionPlaceholder.style.height = `${sectionEl.offsetHeight}px`;
        }
        
        function handleSectionDragEnd(e) {
            if (!draggedSectionId) return;
            const sectionEl = document.querySelector(`[data-section-id="${draggedSectionId}"]`);
            if (sectionEl) sectionEl.classList.remove('dragging-section');
            if (sectionPlaceholder && sectionPlaceholder.parentNode) {
                sectionPlaceholder.parentNode.removeChild(sectionPlaceholder);
            }
            sectionPlaceholder = null;
            draggedSectionId = null;
        }

        function handleSectionDragOver(e) {
            e.preventDefault();
            if (!draggedSectionId || state.desktopLayout !== 'horizontal') return;
            
            const afterElement = getDragAfterElementHorizontal(boardContainer, e.clientX);
            if (afterElement == null) {
                boardContainer.appendChild(sectionPlaceholder);
            } else {
                boardContainer.insertBefore(sectionPlaceholder, afterElement);
            }
        }
        
        function handleSectionDrop(e) {
            e.preventDefault();
            if (!draggedSectionId || state.desktopLayout !== 'horizontal') return;
            
            const section = state.sections.find(s => s.id === draggedSectionId);
            if (!section) return;

            const children = Array.from(boardContainer.children);
            const newIndex = children.indexOf(sectionPlaceholder);

            const action = { type: 'MOVE_SECTION', sectionId: draggedSectionId, newIndex: newIndex };
            submitAction(action);
        }

        // --- ACTION HANDLERS ---
        function handleAction(action) {
            console.log('Handling action:', action);
            
            switch(action.type) {
                case 'ADD_CARD': state.cards.push(action.card); break;
                case 'ADD_SECTION': state.sections.push(action.section); break;
                case 'DELETE_SECTION':
                    state.sections = state.sections.filter(s => s.id !== action.sectionId);
                    state.cards = state.cards.filter(c => c.sectionId !== action.sectionId);
                    break;
                case 'DELETE_CARD':
                    state.cards = state.cards.filter(c => c.id !== action.cardId);
                    break;
                // NEW: Update card
                case 'UPDATE_CARD':
                    state.cards = state.cards.map(c => c.id === action.card.id ? action.card : c);
                    break;
                case 'MOVE_CARD':
                    // ... (no changes)
                    break;
                // NEW: Move section
                case 'MOVE_SECTION':
                    const movedSection = state.sections.find(s => s.id === action.sectionId);
                    let otherSections = state.sections
                        .filter(s => s.id !== action.sectionId)
                        .sort((a,b) => a.order - b.order);
                
                    otherSections.splice(action.newIndex, 0, movedSection);
                    otherSections.forEach((s, index) => s.order = index);
                    break;
                case 'CHAT_MESSAGE':
                    // ... (no changes)
                    return; // Don't re-render whole board
            }
            saveAndRenderLocally();
        }

        function submitAction(action) {
            if (isHost) {
                handleAction(action);
                broadcast(action);
            } else {
                broadcast(action);
            }
        }

        // --- IMPORT / EXPORT LOGIC ---
        // ... (no changes) ...
        
        // --- PEERJS & CHAT LOGIC ---
        function initHost(hostId) {
            if (peer) peer.destroy();
            isHost = true;
            peer = new Peer(hostId);
            
            peer.on('open', (id) => {
                myPeerId = id;
                setConnectionStatus('Waiting for peers...');
                console.log('PeerJS Host ID:', id);
                
                const content = `
                    <p class="text-center">Scan this QR code with your mobile device to join.</p>
                    <canvas id="qr-canvas" class="mx-auto my-4"></canvas>
                    <p class="text-center text-sm text-gray-500">Or manually enter ID:</p>
                    <input type="text" class="w-full bg-gray-100 text-center text-gray-700 p-2 rounded" value="${id}" readonly>
                `;
                showModal('Session Started', content, hideModal);
                
                // FIX: Use setTimeout to wait for modal's DOM
                setTimeout(() => {
                    const canvas = document.getElementById('qr-canvas');
                    if (canvas) {
                        QRCode.toCanvas(canvas, id, (error) => {
                            if (error) console.error("QR Code Generation Error:", error);
                        });
                    } else {
                        console.error("Could not find #qr-canvas element!");
                    }
                }, 100);
            });
            
            peer.on('connection', (conn) => {
                // ... (no changes to connection logic) ...
            });
            
            peer.on('error', (err) => {
                // ... (no changes to error logic) ...
            });
        }
        
        function setConnectionStatus(status) { /* ... (no changes) ... */ }
        function startQRScanner() { /* ... (no changes) ... */ }
        
        // MODIFIED: Host start flow
        startSessionBtn.onclick = () => {
            const defaultId = `decom-board-${Math.floor(1000 + Math.random() * 9000)}`;
            const content = `
                <p class="mb-4">Enter a custom session ID or use the generated one.</p>
                <label class="font-medium">Session ID</label>
                <input type="text" id="custom-peer-id" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2" value="${defaultId}">
                <p id="peer-error" class="text-red-500 text-sm h-4 mt-2"></p>
            `;
            
            showModal('Start a Session', content, () => {
                const customId = document.getElementById('custom-peer-id').value;
                const errorEl = document.getElementById('peer-error');
                if (!customId) { errorEl.textContent = 'Session ID cannot be empty.'; return; }
                if (/\s/.test(customId)) { errorEl.textContent = 'Session ID cannot contain spaces.'; return; }
                
                initHost(customId);
                // MODIFIED: Do not hide modal here. initHost will show the QR modal.
            });
        };
        
        function joinSession() { /* ... (no changes) ... */ }
        joinSessionBtnDesktop.onclick = joinSession;
        mobileJoinBtn.onclick = joinSession;

        function connectToHost(hostId) { /* ... (no changes) ... */ }
        function broadcast(data) { /* ... (no changes) ... */ }
        
        // Chat UI Logic
        chatFab.onclick = () => { /* ... (no changes) ... */ };
        function sendChat() { /* ... (no changes) ... */ }
        chatSendBtn.onclick = sendChat;
        chatInput.onkeydown = (e) => { if (e.key === 'Enter') sendChat(); };

        // --- INITIALIZATION ---
        loadState();
        renderAll();
        window.onresize = renderAll;
        
    </script>
</body>
</html>
