<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mimSense</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JS scripts moved to end of body for correct load order -->
    
    <!-- 6. Quill Rich Text Editor (CSS) -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    
    <script>
        // 7. Configure Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // 'kanban-bg': '#3498db', // This will be set by JS
                        'kanban-section-body': '#f3f4f6',
                        'kanban-card': '#ffffff',
                        'kanban-footer': '#ffffff',
                    }
                }
            }
        }
    </script>
    <!-- 8. Get the "Inter" font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 9. All our custom styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            /* NEW: Added transition for background color */
            transition: background-color 0.3s ease;
        }
        /* Style for the card being dragged */
        .dragging {
            opacity: 0.8;
            transform: rotate(2deg);
        }
        /* Style for the placeholder where the card will drop */
        .drag-placeholder {
            background: rgba(0, 0, 0, 0.05);
            border: 2px dashed #4f46e5;
            border-radius: 0.5rem;
            flex-shrink: 0;
        }
        .section-placeholder {
            width: 100%;
            margin: 0.5rem 0;
            height: 4rem; /* Give placeholder a small height */
        }
        .staging-placeholder {
            margin: 0 0.5rem;
            width: 4rem; /* Give placeholder a small width */
        }
        /* Placeholder for dragging SECTIONS */
        .section-drag-placeholder {
            background: rgba(0, 0, 0, 0.1);
            border: 2px dashed #4f46e5;
            border-radius: 0.5rem;
            flex-shrink: 0;
            width: 320px; /* 80w */
            height: 100%;
        }
        .dragging-section {
             opacity: 0.5;
             transform: scale(1.02);
        }
        /* Hide the native file input */
        #file-input { display: none; }
        /* File-drop overlay */
        #drop-zone {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: none;
            align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(5px);
            border: 4px dashed #4f46e5;
        }
        #drop-zone.active { display: flex; }
        
        /* Modal Styles */
        #modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 1000; display: none;
        }
        #modal-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 1001;
            display: none; width: 90%; max-width: 500px;
            background-color: #ffffff; color: #111827;
        }
        /* Larger modal for editor */
        #modal-container.modal-lg {
            max-width: 800px;
        }
        #modal-container.active,
        #modal-backdrop.active { display: block; }
        
        /* Custom scrollbar */
        .horizontal-scroll {
            scrollbar-color: #4f46e5 #d1d5db; scrollbar-width: thin;
        }
        .horizontal-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .horizontal-scroll::-webkit-scrollbar-track { background: #d1d5db; border-radius: 10px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #4f46e5; border-radius: 10px; }

        /* Color swatches */
        .color-swatch {
            width: 2rem; height: 2rem; border-radius: 9999px;
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
        }
        .color-swatch.selected, .color-swatch:hover {
            border-color: #111827; transform: scale(1.1);
        }

        /* --- Mobile & Chat Styles --- */
        #desktop-ui { display: flex; flex-direction: column; height: 100vh; }
        #mobile-ui { display: none; }
        @media (max-width: 768px) {
            #desktop-ui { display: none; }
            #mobile-ui {
                display: flex; flex-direction: column; height: 100vh;
                overflow: hidden; background-color: #f3f4f6;
            }
            #mobile-swiper {
                flex: 1; display: flex; overflow-x: auto;
                scroll-snap-type: x mandatory; scrollbar-width: none; -ms-overflow-style: none;
            }
            #mobile-swiper::-webkit-scrollbar { display: none; }
            #mobile-swiper > .kanban-section {
                flex: 0 0 100%; scroll-snap-align: center; height: 100%;
                margin: 0; border-radius: 0; box-shadow: none; border: none;
            }
            #mobile-staging-toggle {
                flex-shrink: 0; background-color: #ffffff; border-top: 1px solid #d1d5db;
                padding: 1rem; font-weight: 600; text-align: center; cursor: pointer;
            }
            #mobile-staging-drawer {
                flex-shrink: 0; background-color: #e5e7eb; height: 200px;
                overflow-x: auto; display: none; align-items: center;
                padding: 1rem; gap: 1rem;
            }
            #mobile-staging-drawer.active { display: flex; }
            #mobile-add-card-btn { height: 100%; min-width: 150px; }
        }
        
        /* Chat Bubble */
        #chat-fab {
            position: fixed; bottom: 20px; right: 20px; background-color: #4f46e5; color: white;
            width: 60px; height: 60px; border-radius: 50%; display: none; align-items: center;
            justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 990;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #chat-fab.bouncing { animation: bounce 0.6s 2; }
        
        /* Chat Window */
        #chat-window {
            position: fixed; bottom: 90px; right: 20px; width: 350px; height: 450px; background: white;
            border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); z-index: 989;
            display: none; flex-direction: column; overflow: hidden;
        }
        #chat-window.active { display: flex; }
        #chat-messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        #chat-messages div { margin-bottom: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 12px; max-width: 80%; }
        #chat-messages .my-message { background-color: #4f46e5; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        #chat-messages .peer-message { background-color: #e5e7eb; color: #111827; align-self: flex-start; border-bottom-left-radius: 0; }
        #chat-input-area { display: flex; border-top: 1px solid #e5e7eb; padding: 0.5rem; }
        #chat-input { flex: 1; border: 1px solid #d1d5db; border-radius: 99px; padding: 0.5rem 1rem; margin-right: 0.5rem; }
        #chat-send-btn { background-color: #4f46e5; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; flex-shrink: 0; }
        
        /* QR Code Scanner */
        #qr-reader { width: 100%; border: 2px dashed #4f46e5; border-radius: 8px; }
        /* FIX: New QR Code display div */
        #qr-code-display {
            width: 192px; /* 48 * 4 */
            height: 192px; /* 48 * 4 */
            margin: 1rem auto;
        }
        #qr-code-display img {
            margin: 0 auto;
        }

        /* Quill Editor Styles */
        #quill-editor {
            height: 300px; 
            background-color: #f9fafb;
            color: #111827;
        }
        .ql-tooltip { z-index: 1005; }
        .ql-snow .ql-editor img { max-width: 100%; height: auto; }

        /* Desktop Layout Toggle Styles */
        #board-container.desktop-vertical {
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            gap: 1.5rem; 
        }
        #board-container.desktop-vertical > .kanban-section {
            width: 98%; 
            margin: 0 auto;
            height: auto; 
        }
        #layout-toggle-btns button { display: none; }
        @media (min-width: 769px) {
            #layout-toggle-btns button {
                display: inline-flex;
            }
        }
        
        /* --- NEW: Toast Notification Styles --- */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 320px;
        }
        .toast-notification {
            background-color: white;
            color: #111827;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }
        /* State for sliding in */
        .toast-enter {
            transform: translateX(calc(100% + 1rem));
            opacity: 0;
        }
        /* State for sliding out */
        .toast-exit {
            transform: translateX(calc(100% + 1rem));
            opacity: 0;
        }
        .toast-notification strong {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        /* FIX: Card Drag/Edit Zones */
        .card-drag-handle {
            cursor: grab;
        }
        .card-drag-handle:active {
            cursor: grabbing;
        }
        .card-edit-area {
            cursor: pointer;
        }

    </style>
</head>
<!-- NEW: Background color will be set by JS -->
<body class="bg-kanban-bg text-gray-900 h-screen flex flex-col">

    <!-- =========== DESKTOP UI =========== -->
    <div id="desktop-ui">
        <!-- KANBAN BOARD -->
        <main id="board-container" class="flex-1 flex gap-6 p-6 overflow-x-auto horizontal-scroll desktop-horizontal">
            <!-- Sections and cards will be dynamically generated here -->
        </main>
        
        <!-- STAGING AREA FOOTER -->
        <footer class="flex-shrink: 0; bg-kanban-footer border-t border-gray-200 shadow-inner">
            <div class="flex justify-between items-center px-6 pt-4">
                <div class="flex items-center space-x-4">
                    <h2 class="text-lg font-semibold text-gray-700">Staging Area</h2>
                    <button id="start-session-btn" class="px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-500 transition-all">Start Session</button>
                    <button id="join-session-btn-desktop" class="px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-500 transition-all">Join Session</button>
                    <div id="connection-status" class="text-sm text-gray-500">Offline</div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Layout Toggles -->
                    <div id="layout-toggle-btns" class="flex items-center space-x-2 mr-4">
                        <button id="layout-horizontal-btn" title="Stack Horizontally" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="16" y2="21"></line></svg>
                        </button>
                        <button id="layout-vertical-btn" title="Stack Vertically" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="8" x2="21" y2="8"></line><line x1="3" y1="16" x2="21" y2="16"></line></svg>
                        </button>
                    </div>

                    <!-- NEW: Settings Button -->
                    <button id="settings-btn" title="Settings" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.835 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.835 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.835-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <button id="save-btn" title="Save as .mim backup" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <button id="load-btn" title="Load from .mim file" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.293a1 1 0 011.414 0L9 7.586V15a1 1 0 11-2 0V7.586L5.707 8.707a1 1 0 01-1.414-1.414l3-3z" clip-rule="evenodd" /></svg>
                    </button>
                    <input type="file" id="file-input" accept=".mim">
                </div>
            </div>

            <div id="staging-area" class="card-list flex items-center gap-4 p-6 pt-4 overflow-x-auto horizontal-scroll" data-section-id="staging">
                <button id="add-card-btn" class="w-64 h-24 flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                    + Add New Card
                </button>
            </div>
        </footer>
    </div>
    
    <!-- =========== MOBILE UI =========== -->
    <div id="mobile-ui">
        <main id="mobile-swiper">
            <!-- Mobile sections injected here -->
        </main>
        <footer class="flex-shrink-0">
            <div id="mobile-staging-toggle">Staging Area</div>
            <div id="mobile-staging-drawer" class="card-list" data-section-id="staging">
                <button id="mobile-add-card-btn" class="w-40 h-full flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-600 rounded-lg">
                    + Add Card
                </button>
                <!-- Mobile staging cards injected here -->
            </div>
        </footer>
        <button id="join-session-btn-mobile" class="absolute top-4 right-4 px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-500 transition-all z-50">
            Join
        </button>
        <div id="mobile-connection-status" class="absolute top-5 left-4 text-sm text-gray-500 z-50">Offline</div>
    </div>

    <!-- =========== SHARED UI (Modals, Chat, etc) =========== -->
    <div id="drop-zone" class="text-white text-2xl font-bold"><p>Drop .mim file to load</p></div>
    
    <div id="modal-backdrop"></div>
    <div id="modal-container" class="bg-white rounded-lg shadow-2xl overflow-hidden">
        <div class="p-6">
            <h2 id="modal-title-text" class="text-2xl font-bold text-gray-900 mb-6">Modal Title</h2>
            <div id="modal-content" class="text-gray-700">
                <!-- Modal content injected here -->
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-all">Cancel</button>
            <button id="modal-confirm-btn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-500 transition-all">Confirm</button>
        </div>
    </div>

    <!-- CHAT UI -->
    <div id="chat-fab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </div>
    <div id="chat-window">
        <!-- FIX: Added clear chat button -->
        <div class="p-4 border-b flex justify-between items-center">
            <span class="font-semibold">Chat</span>
            <button id="clear-chat-btn" title="Clear Chat" class="text-gray-400 hover:text-red-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>
        <div id="chat-messages"><div class="peer-message" style="align-self: center; background: #f9fafb; color: #6b7280;">Session started...</div></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="chat-send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 m-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- NEW: Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-20 flex flex-col gap-2 max-w-xs"></div>

    <!-- FIX: Added 'defer' to all library scripts -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js" defer></script>
    <!-- FIX: Swapped to the reliable qrcode.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js" defer></script>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // FIX: Wrap all code in DOMContentLoaded listener
        window.addEventListener('DOMContentLoaded', (event) => {
    
            // --- STATE MANAGEMENT ---
            const boardContainer = document.getElementById('board-container');
            const stagingArea = document.getElementById('staging-area');
            const addCardBtn = document.getElementById('add-card-btn');
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            // NEW: Settings Button
            const settingsBtn = document.getElementById('settings-btn');
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContainer = document.getElementById('modal-container');
            const modalTitleText = document.getElementById('modal-title-text'); 
            const modalContent = document.getElementById('modal-content');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            
            // --- Mobile UI ---
            const mobileSwiper = document.getElementById('mobile-swiper');
            const mobileStagingToggle = document.getElementById('mobile-staging-toggle');
            const mobileStagingDrawer = document.getElementById('mobile-staging-drawer');
            const mobileAddCardBtn = document.getElementById('mobile-add-card-btn');
            const mobileJoinBtn = document.getElementById('join-session-btn-mobile');
            const mobileConnectionStatus = document.getElementById('mobile-connection-status');
            
            // --- Collaboration UI ---
            const startSessionBtn = document.getElementById('start-session-btn');
            const joinSessionBtnDesktop = document.getElementById('join-session-btn-desktop');
            const connectionStatus = document.getElementById('connection-status');
            const chatFab = document.getElementById('chat-fab');
            const chatWindow = document.getElementById('chat-window');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            
            // --- Layout Toggles ---
            const layoutHorizontalBtn = document.getElementById('layout-horizontal-btn');
            const layoutVerticalBtn = document.getElementById('layout-vertical-btn');
            
            // --- Toast Container ---
            const toastContainer = document.getElementById('toast-container');
            
            // NEW: Default settings
            const DEFAULT_BG_COLOR = '#3498db';

            let state = {
                sections: [],
                cards: [],
                chat: [],
                users: {}, // Map of peerId -> userName
                settings: { // NEW
                    backgroundColor: DEFAULT_BG_COLOR
                },
                desktopLayout: 'horizontal'
            };
            
            let onModalConfirm = null;
            let quillEditor = null;
            
            // --- PeerJS variables ---
            let peer = null;
            let myPeerId = null;
            let isHost = false;
            let connections = [];
            let html5QrCode = null;
            
            // --- CORE FUNCTIONS ---
            function saveState() {
                localStorage.setItem('decomBoardState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('decomBoardState');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if (!state.chat) state.chat = [];
                    if (!state.users) state.users = {};
                    if (!state.desktopLayout) state.desktopLayout = 'horizontal';
                    // NEW: Load settings
                    if (!state.settings) {
                        state.settings = { backgroundColor: DEFAULT_BG_COLOR };
                    }
                    if (!state.settings.backgroundColor) {
                        state.settings.backgroundColor = DEFAULT_BG_COLOR;
                    }
                    
                    // Data migration
                    let migrated = false;
                    state.cards.forEach(card => {
                        if (card.hasOwnProperty('serial')) {
                            card.title = card.serial;
                            delete card.serial;
                            migrated = true;
                        }
                        if (card.hasOwnProperty('assetTag')) {
                            if (!card.notes) {
                               card.notes = card.assetTag;
                               delete card.assetTag;
                               migrated = true;
                            }
                        }
                    });
                    if (migrated) {
                        console.log("Data migrated: serial -> title, assetTag -> notes");
                        saveState();
                    }

                } else {
                    state = {
                        sections: [
                            { id: `sec-${Date.now()}`, title: "Backlog", color: "#ec4899", order: 0 },
                            { id: `sec-${Date.now() + 1}`, title: "Doing", color: "#f59e0b", order: 1 },
                            { id: `sec-${Date.now() + 2}`, title: "Done", color: "#10b981", order: 2 }
                        ],
                        cards: [],
                        chat: [],
                        users: {},
                        settings: { backgroundColor: DEFAULT_BG_COLOR },
                        desktopLayout: 'horizontal'
                    };
                }
                // NEW: Apply saved background color on load
                applySettings();
            }
            
            // --- RENDER FUNCTIONS ---
            
            // NEW: Apply settings to the DOM
            function applySettings() {
                document.body.style.backgroundColor = state.settings.backgroundColor || DEFAULT_BG_COLOR;
            }
            
            function renderAll() {
                // NEW: Apply settings *before* rendering
                applySettings();
                
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    renderMobileUI();
                } else {
                    renderDesktopUI();
                }
                renderChat();
                attachEventListeners();
            }
            
            function renderDesktopUI() {
                boardContainer.innerHTML = '';
                
                boardContainer.className = 'flex-1 flex gap-6 p-6 overflow-x-auto horizontal-scroll'; // Reset
                if (state.desktopLayout === 'vertical') {
                    boardContainer.classList.add('desktop-vertical');
                    boardContainer.classList.remove('desktop-horizontal', 'overflow-x-auto');
                } else {
                    boardContainer.classList.add('desktop-horizontal');
                    boardContainer.classList.remove('desktop-vertical', 'overflow-y-auto');
                }

                state.sections
                    .sort((a, b) => a.order - b.order)
                    .forEach(section => {
                        const sectionEl = createSectionElement(section);
                        const cardList = sectionEl.querySelector('.card-list');
                        const sectionCards = state.cards
                            .filter(card => card.sectionId === section.id)
                            .sort((a, b) => a.order - b.order);

                        sectionCards.forEach(card => {
                            const cardEl = createCardElement(card);
                            cardList.appendChild(cardEl);
                        });
                        
                        boardContainer.appendChild(sectionEl);
                });
                
                boardContainer.appendChild(createAddSectionButton());
                
                stagingArea.innerHTML = '';
                const stagingCards = state.cards
                    .filter(card => card.sectionId === 'staging')
                    .sort((a, b) => a.order - b.order);

                stagingCards.forEach(card => {
                    const cardEl = createCardElement(card);
                    stagingArea.appendChild(cardEl);
                });
                stagingArea.appendChild(addCardBtn);
            }
            
            function renderMobileUI() {
                mobileSwiper.innerHTML = ''; 
                
                state.sections
                    .sort((a, b) => a.order - b.order)
                    .forEach(section => {
                        const sectionEl = createSectionElement(section);
                        const cardList = sectionEl.querySelector('.card-list');
                        const sectionCards = state.cards
                            .filter(card => card.sectionId === section.id)
                            .sort((a, b) => a.order - b.order);

                        sectionCards.forEach(card => {
                            const cardEl = createCardElement(card);
                            cardList.appendChild(cardEl);
                        });
                        mobileSwiper.appendChild(sectionEl);
                });
                
                mobileSwiper.appendChild(createAddSectionButton());
                
                mobileStagingDrawer.innerHTML = '';
                const stagingCards = state.cards
                    .filter(card => card.sectionId === 'staging')
                    .sort((a, b) => a.order - b.order);

                stagingCards.forEach(card => {
                    const cardEl = createCardElement(card);
                    mobileStagingDrawer.appendChild(cardEl);
                });
                mobileStagingDrawer.appendChild(mobileAddCardBtn);
            }
            
            function createSectionElement(section) {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'kanban-section w-80 rounded-lg shadow-xl flex flex-col flex-shrink-0 overflow-hidden relative';
                sectionEl.dataset.sectionId = section.id;
                
                const headerColor = section.color || '#6b7280';
                const headerTextColor = '#ffffff';

                sectionEl.innerHTML = `
                    <div draggable="true" class="kanban-section-header p-4 flex justify-between items-center cursor-grab active:cursor-grabbing" style="background-color: ${headerColor}; color: ${headerTextColor};">
                        <h2 class="font-semibold text-lg">${section.title}</h2>
                        <button class="delete-section-btn hover:text-gray-300 z-10" data-section-id="${section.id}" style="color: ${headerTextColor};">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="card-list flex-1 p-4 space-y-4 overflow-y-auto horizontal-scroll bg-kanban-section-body" data-section-id="${section.id}">
                        <!-- Cards go here -->
                    </div>
                `;
                return sectionEl;
            }
            
            function createAddSectionButton() {
                const addSectionBtnEl = document.createElement('button');
                addSectionBtnEl.id = 'add-section-btn';
                addSectionBtnEl.className = 'w-80 h-24 flex-shrink-0 flex items-center justify-center px-4 py-2 bg-gray-200/50 text-gray-600 rounded-lg hover:bg-gray-200 hover:text-gray-800 transition-all border-2 border-dashed border-gray-400';
                addSectionBtnEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 0V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2z" />
                    </svg>
                    + Add New Section
                `;
                if(state.desktopLayout === 'vertical') {
                    addSectionBtnEl.classList.add('w-full', 'mx-auto', 'max-w-7xl');
                }
                return addSectionBtnEl;
            }

            // FIX: Re-designed card for separate drag/edit zones
            function createCardElement(card) {
                const cardEl = document.createElement('div');
                const isStaging = card.sectionId === 'staging';
                const cardWidthClass = isStaging ? 'w-64' : 'w-full';

                // FIX: Removed relative positioning from here, it's not needed
                cardEl.className = `kanban-card bg-kanban-card text-gray-900 rounded-md shadow hover:shadow-lg transition-all ${cardWidthClass} flex-shrink-0 flex flex-col`;
                cardEl.dataset.cardId = card.id;
                
                const hasNotes = card.notes && card.notes.trim() !== '' && card.notes.trim() !== '<p><br></p>';
                const hasImages = card.notes && card.notes.includes('<img');
                
                // --- Card Top (Drag Handle) ---
                const dragHandle = document.createElement('div');
                // FIX: Added data-action for drag
                dragHandle.className = 'card-drag-handle p-4 pt-3 pb-2 cursor-grab active:cursor-grabbing';
                dragHandle.draggable = true; // The handle is ALWAYS draggable
                dragHandle.dataset.action = "drag";
                
                dragHandle.innerHTML = `
                    <div class="flex justify-between items-start pointer-events-none"> <!-- Pointer events none so drag is clean -->
                        <p class="font-medium text-gray-800 break-all">${card.title}</p>
                        <button class="delete-card-btn text-gray-400 hover:text-red-500 z-20 pointer-events-auto" data-card-id="${card.id}"> <!-- button needs pointer events -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
                
                // --- Card Bottom (Edit Area) ---
                const editArea = document.createElement('div');
                // FIX: Added data-action for edit
                editArea.className = 'card-edit-area p-4 pt-2 cursor-pointer';
                editArea.dataset.action = "edit";
                editArea.innerHTML = `
                    <div class="flex justify-between items-end mt-2">
                        <div class="flex space-x-2">
                            ${hasNotes ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>` : ''}
                            ${hasImages ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01" /></svg>` : ''}
                        </div>
                        <div class="h-8 w-8 bg-gray-300 rounded-full flex-shrink-0"></div>
                    </div>
                `;

                cardEl.appendChild(dragHandle);
                cardEl.appendChild(editArea);
                
                return cardEl;
            }
            
            function renderChat() { 
                chatMessages.innerHTML = '';
                [...state.chat].reverse().forEach(msg => {
                    const msgEl = document.createElement('div');
                    const userName = state.users[msg.peerId] || `Peer ${msg.peerId.slice(0, 4)}...`;
                    
                    if (msg.peerId === myPeerId) {
                        msgEl.className = 'my-message';
                        msgEl.textContent = msg.text;
                    } else {
                        msgEl.className = 'peer-message';
                        msgEl.innerHTML = `<strong class="block text-xs">${userName}</strong> ${msg.text}`;
                    }
                    chatMessages.appendChild(msgEl);
                });
            }

            function attachEventListeners() {
                // Click Listeners
                addCardBtn.onclick = handleAddCardClick;
                mobileAddCardBtn.onclick = handleAddCardClick;
                settingsBtn.onclick = handleSettingsClick; // NEW
                
                const addSectionBtn = document.getElementById('add-section-btn');
                if (addSectionBtn) addSectionBtn.onclick = handleAddSectionClick;
                
                const mainApp = document.body;
                
                mainApp.removeEventListener('click', handleAppClick); 
                mainApp.addEventListener('click', handleAppClick);

                // FIX: Consolidated dragstart handler
                mainApp.removeEventListener('dragstart', onDragStart); 
                mainApp.addEventListener('dragstart', onDragStart);

                mainApp.removeEventListener('dragend', onDragEnd);
                mainApp.addEventListener('dragend', onDragEnd);
                
                const dropZones = document.querySelectorAll('.card-list');
                dropZones.forEach(zone => {
                    zone.removeEventListener('dragover', handleDragOver);
                    zone.addEventListener('dragover', handleDragOver);
                    zone.removeEventListener('drop', handleDrop);
                    zone.addEventListener('drop', handleDrop);
                });
                
                boardContainer.removeEventListener('dragover', handleSectionDragOver);
                boardContainer.addEventListener('dragover', handleSectionDragOver);
                boardContainer.removeEventListener('drop', handleSectionDrop);
                boardContainer.addEventListener('drop', handleSectionDrop);

                // Mobile Listeners
                mobileStagingToggle.onclick = () => {
                    mobileStagingDrawer.classList.toggle('active');
                };
                
                // Layout Toggle Listeners
                layoutHorizontalBtn.onclick = () => {
                    state.desktopLayout = 'horizontal';
                    saveAndRenderLocally();
                };
                layoutVerticalBtn.onclick = () => {
                    state.desktopLayout = 'vertical';
                    saveAndRenderLocally();
                };
            }
            
            // FIX: Updated click handler for new card structure
            function handleAppClick(e) {
                const deleteCardBtn = e.target.closest('.delete-card-btn');
                if (deleteCardBtn) {
                    e.stopPropagation();
                    handleDeleteCardClick(deleteCardBtn.dataset.cardId);
                    return;
                }
                
                const deleteSectionBtn = e.target.closest('.delete-section-btn');
                if (deleteSectionBtn) {
                    e.stopPropagation();
                    handleDeleteSectionClick(deleteSectionBtn.dataset.sectionId);
                    return;
                }
                
                // FIX: Check for the new edit area
                const editCardArea = e.target.closest('.card-edit-area');
                if (editCardArea) {
                    e.stopPropagation();
                    const cardId = editCardArea.closest('.kanban-card').dataset.cardId;
                    handleEditCardClick(cardId);
                    return;
                }
            }
            
            function saveAndRenderLocally() {
                saveState();
                renderAll();
            }
            
            // --- MODAL HANDLERS ---
            function showModal(title, contentHTML, onConfirmCallback, modalSize = 'md') {
                modalTitleText.textContent = title; 
                modalContent.innerHTML = contentHTML;
                onModalConfirm = onConfirmCallback;
                
                if (modalSize === 'lg') {
                    modalContainer.classList.add('modal-lg');
                } else {
                    modalContainer.classList.remove('modal-lg');
                }
                
                modalContainer.classList.add('active');
                modalBackdrop.classList.add('active');
                
                const firstInput = modalContent.querySelector('input, textarea');
                if (firstInput) firstInput.focus();
                
                if (title === 'Join Session') startQRScanner();
            }
            
            function hideModal() {
                onModalConfirm = null;
                if (quillEditor) quillEditor = null;
                modalContainer.classList.remove('active', 'modal-lg');
                modalBackdrop.classList.remove('active');
                modalContent.innerHTML = '';
                
                if (html5QrCode && html5QrCode.getState() === Html5Qrcode.SCANNING) {
                    html5QrCode.stop().catch(err => console.error("Error stopping scanner:", err));
                }
            }
            
            modalCancelBtn.onclick = hideModal;
            modalConfirmBtn.onclick = () => {
                if (onModalConfirm) onModalConfirm();
            };
            
            // --- NEW: Toast Notification Function ---
            function showToast(title, message) {
                const toast = document.createElement('div');
                toast.className = 'toast-notification toast-enter';
                // Truncate long messages
                const snippet = message.length > 50 ? message.substring(0, 50) + '...' : message;
                toast.innerHTML = `<strong>${title}</strong><p>${snippet}</p>`;
                toastContainer.prepend(toast); 
                
                // Trigger the slide-in animation
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        toast.classList.remove('toast-enter');
                    });
                });

                // Set timers to slide out and remove
                setTimeout(() => {
                    toast.classList.add('toast-exit');
                    toast.addEventListener('transitionend', () => {
                        toast.remove();
                    });
                }, 3000); // 3 seconds visible
            }

            // --- CLICK HANDLERS ---
            
            function handleAddCardClick() {
                const content = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="modal-card-title-input" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                        <p id="modal-error" class="text-red-500 text-sm h-4"></p>
                    </div>
                `;
                showModal('Add New Card', content, () => {
                    const title = document.getElementById('modal-card-title-input').value; 
                    const errorEl = document.getElementById('modal-error');
                    
                    if (title) {
                        const newCard = {
                            id: `card-${Date.now()}`,
                            title: title,
                            notes: '', 
                            sectionId: 'staging',
                            order: state.cards.filter(c => c.sectionId === 'staging').length
                        };
                        
                        const action = { type: 'ADD_CARD', card: newCard };
                        submitAction(action);
                        hideModal();
                    } else {
                        errorEl.textContent = 'Title is required.';
                        document.getElementById('modal-card-title-input').focus();
                    }
                });
            }
            
            function handleEditCardClick(cardId) {
                const card = state.cards.find(c => c.id === cardId);
                if (!card) return;
                
                const content = `
                    <div id="quill-editor"></div>
                    <p id="modal-error" class="text-red-500 text-sm h-4 mt-2"></p>
                `;
                
                showModal(`Edit Card: ${card.title}`, content, () => {
                    const notesContent = quillEditor.root.innerHTML;
                    const updatedCard = { ...card, notes: notesContent };
                    
                    const action = { type: 'UPDATE_CARD', card: updatedCard };
                    submitAction(action);
                    hideModal();
                }, 'lg'); 
                
                requestAnimationFrame(() => {
                    try {
                        quillEditor = new Quill('#quill-editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline', 'strike'],
                                    [{'list': 'ordered'}, {'list': 'bullet'}],
                                    ['link', 'image', 'code-block'],
                                    ['clean']
                                ]
                            }
                        });
                        
                        quillEditor.getModule('toolbar').addHandler('image', () => {
                            const input = document.createElement('input');
                            input.setAttribute('type', 'file');
                            input.setAttribute('accept', 'image/*');
                            input.click();
                            
                            input.onchange = () => {
                                const file = input.files[0];
                                if (/^image\//.test(file.type)) {
                                    const reader = new FileReader();
                                    reader.onload = (e) => {
                                        const range = quillEditor.getSelection(true);
                                        quillEditor.insertEmbed(range.index, 'image', e.target.result);
                                        quillEditor.setSelection(range.index + 1);
                                    };
                                    reader.readAsDataURL(file);
                                } else {
                                    console.warn('You can only upload images.');
                                }
                            };
                        });

                        quillEditor.root.innerHTML = card.notes;
                    } catch (err) {
                        console.error("Quill init failed:", err);
                        modalContent.innerHTML = "<p class='text-red-500'>Error loading editor.</p>";
                    }
                });
            }
            
            function handleAddSectionClick() {
                const sectionColors = ['#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#6b7280', '#8b5cf6', '#ef4444'];
                let selectedColor = sectionColors[0]; 
                const colorSwatchesHTML = sectionColors.map((color, index) => `
                    <div class="color-swatch ${index === 0 ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"></div>
                `).join('');

                const content = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Section Title</label>
                            <input type="text" id="modal-section-title-input" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Header Color</label>
                            <div class="flex space-x-2 mt-2 flex-wrap gap-2">
                                ${colorSwatchesHTML}
                            </div>
                        </div>
                        <p id="modal-error" class="text-red-500 text-sm h-4"></p>
                    </div>
                `;
                
                showModal('Add New Section', content, () => {
                    const title = document.getElementById('modal-section-title-input').value;
                    const errorEl = document.getElementById('modal-error');
                    
                    if (title) {
                        const newSection = {
                            id: `sec-${Date.now()}`,
                            title: title,
                            color: selectedColor,
                            order: state.sections.length 
                        };
                        
                        const action = { type: 'ADD_SECTION', section: newSection };
                        submitAction(action);
                        hideModal();
                    } else {
                        errorEl.textContent = 'Title is required.';
                        document.getElementById('modal-section-title-input').focus();
                    }
                });
                
                const swatches = modalContent.querySelectorAll('.color-swatch');
                swatches.forEach(swatch => {
                    swatch.addEventListener('click', () => {
                        swatches.forEach(s => s.classList.remove('selected'));
                        swatch.classList.add('selected');
                        selectedColor = swatch.dataset.color;
                    });
                });
            }
            
            function handleDeleteSectionClick(sectionId) {
                showModal(
                    'Delete Section?',
                    `<p>Are you sure you want to delete this section? All cards in it will be permanently lost.</p>`,
                    () => {
                        const action = { type: 'DELETE_SECTION', sectionId: sectionId };
                        submitAction(action);
                        hideModal();
                    }
                );
            }
            
            function handleDeleteCardClick(cardId) {
                showModal(
                    'Delete Card?',
                    `<p>Are you sure you want to delete this card?</p>`,
                    () => {
                        const action = { type: 'DELETE_CARD', cardId: cardId };
                        submitAction(action);
                        hideModal();
                    }
                );
            }
            
            // NEW: Settings modal handler
            function handleSettingsClick() {
                const bgColors = ['#3498db', '#34495e', '#1abc9c', '#9b59b6', '#e67e22', '#e74c3c'];
                let selectedBgColor = state.settings.backgroundColor;
                
                const bgSwatchesHTML = bgColors.map(color => `
                    <div class="color-swatch ${color === selectedBgColor ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"></div>
                `).join('');

                const content = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">App Background Color</label>
                            <div class="flex space-x-2 mt-2 flex-wrap gap-2">
                                ${bgSwatchesHTML}
                            </div>
                        </div>
                    </div>
                `;
                
                // Use "null" for confirm callback, we'll apply instantly
                showModal('App Settings', content, () => {
                    // This will be called on "Confirm", so we just hide
                    hideModal();
                });
                
                // Add listeners to swatches to apply *instantly*
                const swatches = modalContent.querySelectorAll('.color-swatch');
                swatches.forEach(swatch => {
                    swatch.addEventListener('click', () => {
                        swatches.forEach(s => s.classList.remove('selected'));
                        swatch.classList.add('selected');
                        selectedBgColor = swatch.dataset.color;
                        
                        // Apply and save
                        const action = { type: 'UPDATE_BG_COLOR', color: selectedBgColor };
                        submitAction(action);
                    });
                });
            }

            // --- DRAG-N-DROP LOGIC ---
            let draggedCardId = null;
            let placeholder = null;
            let draggedSectionId = null;
            let sectionPlaceholder = null;
            
            // FIX: Consolidated drag start
            function onDragStart(e) {
                const sectionHeader = e.target.closest('.kanban-section-header');
                const cardDragHandle = e.target.closest('.card-drag-handle');

                if (sectionHeader && state.desktopLayout === 'horizontal') {
                    // It's a section drag
                    handleSectionDragStart(e);
                } else if (cardDragHandle) {
                    // It's a card drag
                    handleCardDragStart(e);
                } else {
                    // Not dragging something we care about
                    e.preventDefault();
                }
            }
            
            // FIX: Consolidated drag end
            function onDragEnd(e) {
                if (draggedCardId) {
                    handleCardDragEnd(e);
                }
                if (draggedSectionId) {
                    handleSectionDragEnd(e);
                }
            }

            // FIX: Renamed and simplified
            function handleCardDragStart(e) {
                const cardEl = e.target.closest('.kanban-card');
                if (!cardEl) return;
                
                draggedCardId = cardEl.dataset.cardId;
                setTimeout(() => cardEl.classList.add('dragging'), 0);
                
                placeholder = document.createElement('div');
                placeholder.className = 'drag-placeholder';
            }
            
            function handleCardDragEnd(e) {
                if (!draggedCardId) return;
                const cardEl = document.querySelector(`[data-card-id="${draggedCardId}"]`);
                if (cardEl) cardEl.classList.remove('dragging');
                if (placeholder && placeholder.parentNode) {
                    placeholder.parentNode.removeChild(placeholder);
                }
                placeholder = null;
                draggedCardId = null;
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                // This function now ONLY handles card dragging
                const dropZone = e.target.closest('.card-list');
                if (!dropZone || !placeholder) return;
                
                const isHorizontal = dropZone.id === 'staging-area' || dropZone.id === 'mobile-staging-drawer';
                
                // FIX: Adjust placeholder style based on the drop zone
                const draggingCard = document.querySelector(`[data-card-id="${draggedCardId}"]`);
                if (!draggingCard) return;

                if (isHorizontal) {
                    placeholder.classList.add('staging-placeholder');
                    placeholder.classList.remove('section-placeholder');
                    placeholder.style.width = `${draggingCard.offsetWidth}px`;
                    placeholder.style.height = `${draggingCard.offsetHeight}px`;
                } else {
                    placeholder.classList.add('section-placeholder');
                    placeholder.classList.remove('staging-placeholder');
                    placeholder.style.width = '100%';
                    placeholder.style.height = `${draggingCard.offsetHeight}px`;
                }
                
                if (isHorizontal) {
                    handleDragOverHorizontal(e, dropZone);
                } else {
                    handleDragOverVertical(e, dropZone);
                }
            }
            function handleDragOverVertical(e, dropZone) {
                const afterElement = getDragAfterElementVertical(dropZone, e.clientY);
                if (afterElement == null) {
                    dropZone.appendChild(placeholder);
                } else {
                    dropZone.insertBefore(placeholder, afterElement);
                }
            }
            function handleDragOverHorizontal(e, dropZone) {
                const afterElement = getDragAfterElementHorizontal(dropZone, e.clientX);
                if (afterElement == null) {
                    dropZone.appendChild(placeholder);
                } else {
                    dropZone.insertBefore(placeholder, afterElement);
                }
            }
            function handleDrop(e) {
                e.preventDefault();
                if (!draggedCardId) return; // Only handle card drops
                const dropZone = e.target.closest('.card-list');
                if (!dropZone) return;
                
                const newSectionId = dropZone.dataset.sectionId; 

                const children = Array.from(dropZone.children).filter(c => !c.classList.contains('dragging'));
                let newIndex = children.indexOf(placeholder);
                if (newIndex === -1) {
                    if(placeholder.parentNode === dropZone) {
                       newIndex = Array.from(dropZone.children).indexOf(placeholder);
                    } else {
                       newIndex = children.length;
                    }
                }

                const action = {
                    type: 'MOVE_CARD',
                    cardId: draggedCardId,
                    newSectionId: newSectionId,
                    newIndex: newIndex
                };
                submitAction(action);
            }
            function getDragAfterElementVertical(container, y) {
                const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            function getDragAfterElementHorizontal(container, x) {
                const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging), .kanban-section:not(.dragging-section)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            // --- SECTION DRAG-N-DROP LOGIC ---
            function handleSectionDragStart(e) {
                if (e.target.closest('.delete-section-btn')) {
                    e.preventDefault();
                    return;
                }
                
                const sectionEl = e.target.closest('.kanban-section');
                if (!sectionEl) {
                    e.preventDefault();
                    return;
                }
                draggedSectionId = sectionEl.dataset.sectionId;
                setTimeout(() => sectionEl.classList.add('dragging-section'), 0);
                
                sectionPlaceholder = document.createElement('div');
                sectionPlaceholder.className = 'section-drag-placeholder';
                sectionPlaceholder.style.height = `${sectionEl.offsetHeight}px`;
            }
            
            function handleSectionDragEnd(e) {
                if (!draggedSectionId) return;
                const sectionEl = document.querySelector(`[data-section-id="${draggedSectionId}"]`);
                if (sectionEl) sectionEl.classList.remove('dragging-section');
                if (sectionPlaceholder && sectionPlaceholder.parentNode) {
                    sectionPlaceholder.parentNode.removeChild(sectionPlaceholder);
                }
                sectionPlaceholder = null;
                draggedSectionId = null;
            }

            function handleSectionDragOver(e) {
                e.preventDefault();
                // This function ONLY handles section dragging
                if (!draggedSectionId || state.desktopLayout !== 'horizontal' || !sectionPlaceholder) return;
                
                const afterElement = getDragAfterElementHorizontal(boardContainer, e.clientX);
                if (afterElement == null) {
                    // Don't append if it's over the add button
                    if (!e.target.closest('#add-section-btn')) {
                        boardContainer.appendChild(sectionPlaceholder);
                    }
                } else {
                    boardContainer.insertBefore(sectionPlaceholder, afterElement);
                }
            }
            
            function handleSectionDrop(e) {
                e.preventDefault();
                if (!draggedSectionId) return; // Only handle section drops
                
                const section = state.sections.find(s => s.id === draggedSectionId);
                if (!section) return;

                const children = Array.from(boardContainer.children).filter(c => !c.classList.contains('dragging-section') && !c.id.includes('add-section-btn'));
                let newIndex = children.indexOf(sectionPlaceholder);
                if (newIndex === -1) {
                    if(sectionPlaceholder.parentNode === boardContainer) {
                       newIndex = Array.from(boardContainer.children).indexOf(sectionPlaceholder);
                    } else {
                       newIndex = children.length;
                    }
                }

                const action = { type: 'MOVE_SECTION', sectionId: draggedSectionId, newIndex: newIndex };
                submitAction(action);
            }

            // --- ACTION HANDLERS ---
            function handleAction(action) {
                console.log('Handling action:', action);
                
                switch(action.type) {
                    case 'ADD_CARD': state.cards.push(action.card); break;
                    case 'ADD_SECTION': state.sections.push(action.section); break;
                    case 'DELETE_SECTION':
                        state.sections = state.sections.filter(s => s.id !== action.sectionId);
                        state.cards = state.cards.filter(c => c.sectionId !== action.sectionId);
                        break;
                    case 'DELETE_CARD':
                        state.cards = state.cards.filter(c => c.id !== action.cardId);
                        break;
                    case 'UPDATE_CARD':
                        state.cards = state.cards.map(c => c.id === action.card.id ? action.card : c);
                        break;
                    case 'MOVE_CARD':
                        const card = state.cards.find(c => c.id === action.cardId);
                        if (!card) return;
                        card.sectionId = action.newSectionId;
                        let otherCards = state.cards
                            .filter(c => c.sectionId === action.newSectionId && c.id !== action.cardId)
                            .sort((a,b) => a.order - b.order);
                        otherCards.splice(action.newIndex, 0, card);
                        otherCards.forEach((c, index) => c.order = index);
                        break;
                    case 'MOVE_SECTION':
                        const movedSection = state.sections.find(s => s.id === action.sectionId);
                        let otherSections = state.sections
                            .filter(s => s.id !== action.sectionId)
                            .sort((a,b) => a.order - b.order);
                        otherSections.splice(action.newIndex, 0, movedSection);
                        otherSections.forEach((s, index) => s.order = index);
                        break;
                    case 'ANNOUNCE_USER':
                        state.users[action.peerId] = action.userName;
                        renderChat(); 
                        return; 
                    case 'CHAT_MESSAGE':
                        state.chat.push(action.message);
                        renderChat();
                        if (action.message.peerId !== myPeerId && !chatWindow.classList.contains('active')) {
                            const userName = state.users[action.message.peerId] || 'A peer';
                            showToast(`New Message from ${userName}`, action.message.text);
                        }
                        if (action.message.peerId !== myPeerId) {
                            chatFab.classList.add('bouncing');
                            setTimeout(() => chatFab.classList.remove('bouncing'), 1200);
                        }
                        return; 
                    // FIX: Moved 'CLEAR_CHAT' inside the switch
                    case 'CLEAR_CHAT':
                        state.chat = [];
                        renderChat();
                        return;
                    // NEW: Update settings
                    case 'UPDATE_BG_COLOR':
                        state.settings.backgroundColor = action.color;
                        applySettings(); // Apply instantly
                        break; // Will fall through to saveAndRender
                }
                saveAndRenderLocally();
            }

            function submitAction(action) {
                if (isHost || !peer) { // If host OR offline
                    handleAction(action);
                    if (isHost) broadcast(action);
                } else { // If client
                    broadcast(action);
                }
            }

            // --- IMPORT / EXPORT LOGIC ---
            saveBtn.onclick = handleSaveFile;
            loadBtn.onclick = () => fileInput.click();
            fileInput.onchange = handleLoadFile;

            function handleSaveFile() {
                const data = JSON.stringify(state, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mimsense_backup_${new Date().toISOString().split('T')[0]}.mim`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function handleLoadFile(e) {
                const file = e.target.files[0];
                if (file) loadMimFile(file);
                e.target.value = null;
            }
            
            window.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (e.dataTransfer.items && e.dataTransfer.items.length > 0 && e.dataTransfer.items[0].kind === 'file') {
                    dropZone.classList.add('active');
                }
            });
            dropZone.addEventListener('dragleave', (e) => {
                if (e.relatedTarget === null || !dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('active');
                }
            });
            dropZone.addEventListener('dragover', (e) => e.preventDefault());
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.endsWith('.mim')) loadMimFile(file);
                    else alert('Not a .mim file!');
                }
            });
            
            function loadMimFile(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const newState = JSON.parse(event.target.result);
                        if (newState && newState.sections && newState.cards) {
                            state = newState;
                            if (!state.chat) state.chat = [];
                            if (!state.users) state.users = {};
                            if (!state.desktopLayout) state.desktopLayout = 'horizontal';
                            if (!state.settings) state.settings = { backgroundColor: DEFAULT_BG_COLOR };
                            
                            saveAndRenderLocally();
                            
                            if (isHost) {
                                broadcast({ type: 'FULL_STATE', payload: state });
                            }
                        } else throw new Error('Invalid file format');
                    } catch (err) {
                        console.error('Error loading .mim file:', err);
                        alert('Could not load .mim file.');
                    }
                };
                reader.readAsText(file);
            }
            
            // --- PEERJS & CHAT LOGIC ---
            function initHost(hostId, userName) {
                if (peer) peer.destroy();
                isHost = true;
                peer = new Peer(hostId);
                
                peer.on('open', (id) => {
                    myPeerId = id;
                    state.users[myPeerId] = userName;
                    setConnectionStatus('Waiting for peers...');
                    console.log('PeerJS Host ID:', id);
                    
                    const content = `
                        <p class="text-center">Scan this QR code with your mobile device to join.</p>
                        <!-- FIX: Use a div for the new QR library -->
                        <div id="qr-code-display" class="mx-auto my-4 w-48 h-48"></div>
                        <p class="text-center text-sm text-gray-500">Or manually enter ID:</p>
                        <input type="text" class="w-full bg-gray-100 text-center text-gray-700 p-2 rounded" value="${id}" readonly>
                    `;
                    hideModal(); 
                    showModal('Session Started', content, hideModal);
                    
                    // FIX: Use double requestAnimationFrame for QR code
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const qrCodeEl = document.getElementById('qr-code-display');
                            if (qrCodeEl) {
                                // FIX: Use the new QRCode.js API
                                new QRCode(qrCodeEl, {
                                    text: id,
                                    width: 192,
                                    height: 192,
                                    colorDark : "#000000",
                                    colorLight : "#ffffff",
                                    correctLevel : QRCode.CorrectLevel.H
                                });
                            } else {
                                console.error("Could not find #qr-code-display element!");
                            }
                        });
                    });
                });
                
                peer.on('connection', (conn) => {
                    console.log('Peer connected:', conn.peer);
                    connections.push(conn);
                    setConnectionStatus(`Connected (${connections.length} peer${connections.length > 1 ? 's' : ''})`);
                    chatFab.style.display = 'flex';
                    
                    conn.on('open', () => {
                        conn.send({ type: 'FULL_STATE', payload: state });
                    });
                    
                    conn.on('data', (data) => {
                        console.log('Host received data:', data);
                        if (data.type === 'ANNOUNCE_USER') {
                            state.users[data.peerId] = data.userName;
                        }
                        handleAction(data);
                        broadcast(data); 
                    });
                    
                    conn.on('close', () => {
                        connections = connections.filter(c => c.peer !== conn.peer);
                        delete state.users[conn.peer];
                        setConnectionStatus(connections.length > 0 ? `Connected (${connections.length} peer${connections.length > 1 ? 's' : ''})` : 'Waiting for peers...');
                    });
                });
                
                peer.on('error', (err) => {
                    console.error('PeerJS Host Error:', err);
                    if (err.type === 'unavailable-id') {
                        setConnectionStatus('Offline');
                         const savedName = localStorage.getItem('decomBoardUserName') || '';
                         // FIX: Rename default ID
                         const defaultId = `mimsense-${Math.floor(1000 + Math.random() * 9000)}`;
                         const content = `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                                    <input type="text" id="modal-user-name" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2" value="${savedName}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Session ID</label>
                                    <input type="text" id="custom-peer-id" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2" value="${defaultId}">
                                </div>
                                <p id="peer-error" class="text-red-500 text-sm h-4 mt-2">Error: That ID is already taken. Try another.</p>
                            </div>
                        `;
                        hideModal();
                        showModal('Start a Session', content, () => {
                            const newCustomId = document.getElementById('custom-peer-id').value;
                            const userName = document.getElementById('modal-user-name').value;
                            if (newCustomId && userName) {
                                 localStorage.setItem('decomBoardUserName', userName);
                                 initHost(newCustomId, userName);
                            }
                        });
                    }
                });
            }
            
            function setConnectionStatus(status) {
                connectionStatus.textContent = status;
                mobileConnectionStatus.textContent = status;
                if (status === 'Offline') {
                    connectionStatus.className = 'text-sm text-gray-500';
                    mobileConnectionStatus.className = 'absolute top-5 left-4 text-sm text-gray-500 z-50';
                } else if (status.startsWith('Connected')) {
                    connectionStatus.className = 'text-sm text-green-600 font-medium';
                    mobileConnectionStatus.className = 'absolute top-5 left-4 text-sm text-green-600 font-medium z-50';
                } else {
                    connectionStatus.className = 'text-sm text-yellow-600';
                    mobileConnectionStatus.className = 'absolute top-5 left-4 text-sm text-yellow-600 z-50';
                }
            }
            function startQRScanner() {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                html5QrCode.start({ facingMode: "environment" }, config, 
                    (decodedText, decodedResult) => {
                        // Success
                        console.log(`QR Scanned: ${decodedText}`);
                        html5QrCode.stop();
                        // Now find the other inputs in the modal
                        const userName = document.getElementById('modal-user-name').value;
                        const errorEl = document.getElementById('peer-error');
                        
                        if (!userName) {
                            errorEl.textContent = 'Your name is required.';
                            // Don't close modal, let user enter name
                            html5QrCode.start({ facingMode: "environment" }, config, ()=>{}, ()=>{}); // Restart
                            return;
                        }
                        
                        localStorage.setItem('decomBoardUserName', userName);
                        connectToHost(decodedText, userName);
                        hideModal();
                    },
                    (errorMessage) => { /* console.log(errorMessage); */ } 
                ).catch((err) => {
                    console.error("Cannot start QR scanner:", err);
                    modalContent.innerHTML += `<p class="text-red-500">Could not start camera. Check permissions.</p>`;
                });
            }
            
            startSessionBtn.onclick = () => {
                const savedName = localStorage.getItem('decomBoardUserName') || '';
                // FIX: Rename default ID
                const defaultId = `mimsense-${Math.floor(1000 + Math.random() * 9000)}`;
                const content = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                            <input type="text" id="modal-user-name" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2" value="${savedName}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Session ID</label>
                            <input type="text" id="custom-peer-id" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2" value="${defaultId}">
                        </div>
                        <p id="peer-error" class="text-red-500 text-sm h-4 mt-2"></p>
                    </div>
                `;
                
                showModal('Start a Session', content, () => {
                    const customId = document.getElementById('custom-peer-id').value;
                    const userName = document.getElementById('modal-user-name').value;
                    const errorEl = document.getElementById('peer-error');
                    
                    if (!userName) { errorEl.textContent = 'Your name is required.'; return; }
                    if (!customId) { errorEl.textContent = 'Session ID cannot be empty.'; return; }
                    if (/\s/.test(customId)) { errorEl.textContent = 'Session ID cannot contain spaces.'; return; }
                    
                    localStorage.setItem('decomBoardUserName', userName);
                    initHost(customId, userName);
                });
            };
            
            function joinSession() {
                const savedName = localStorage.getItem('decomBoardUserName') || '';
                const content = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                            <input type="text" id="modal-user-name" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2" value="${savedName}">
                        </div>
                        <p class="mb-4">Scan the QR code from the host's screen.</p>
                        <div id="qr-reader"></div>
                        <p class="text-center text-gray-500 my-2">OR</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Enter Host ID</label>
                            <input type="text" id="manual-peer-id" class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg p-2">
                        </div>
                        <p id="peer-error" class="text-red-500 text-sm h-4 mt-2"></p>
                    </div>
                `;
                showModal('Join Session', content, () => {
                    const manualId = document.getElementById('manual-peer-id').value;
                    const userName = document.getElementById('modal-user-name').value;
                    const errorEl = document.getElementById('peer-error');
                    
                    if (!userName) { errorEl.textContent = 'Your name is required.'; return; }
                    if (!manualId) { errorEl.textContent = 'Host ID is required.'; return; }
                    
                    localStorage.setItem('decomBoardUserName', userName);
                    connectToHost(manualId, userName);
                    hideModal();
                });
            }
            joinSessionBtnDesktop.onclick = joinSession;
            mobileJoinBtn.onclick = joinSession;

            function connectToHost(hostId, userName) {
                if (peer) peer.destroy();
                peer = new Peer();
                isHost = false;
                
                peer.on('open', (id) => {
                    myPeerId = id;
                    console.log('Client Peer ID:', id, 'connecting to', hostId);
                    setConnectionStatus('Connecting...');
                    
                    const conn = peer.connect(hostId);
                    connections = [conn];
                    
                    conn.on('open', () => {
                        console.log('Connected to host!');
                        setConnectionStatus('Connected (Client)');
                        chatFab.style.display = 'flex';
                        broadcast({ type: 'ANNOUNCE_USER', peerId: myPeerId, userName: userName });
                    });
                    
                    conn.on('data', (data) => {
                        console.log('Client received data:', data);
                        if (data.type === 'FULL_STATE') {
                            state = data.payload;
                            saveAndRenderLocally();
                        } else {
                            handleAction(data);
                        }
                    });
                    
                    conn.on('close', () => {
                        setConnectionStatus('Offline (Disconnected)');
                        chatFab.style.display = 'none';
                        connections = [];
                    });
                });
                
                peer.on('error', (err) => console.error('PeerJS Client Error:', err));
            }
            
            function broadcast(data) {
                connections.forEach(conn => {
                    if (conn && conn.open) {
                        conn.send(data);
                    }
                });
            }
            
            // Chat UI Logic
            chatFab.onclick = () => {
                chatWindow.classList.toggle('active');
                chatFab.classList.remove('bouncing');
            };
            
            // NEW: Clear Chat
            clearChatBtn.onclick = () => {
                const action = { type: 'CLEAR_CHAT' };
                submitAction(action);
            };

            function sendChat() {
                const text = chatInput.value;
                if (text.trim() === '') return;
                
                const message = { peerId: myPeerId, text: text };
                const action = { type: 'CHAT_MESSAGE', message: message };
                
                submitAction(action);
                chatInput.value = '';
            }
            chatSendBtn.onclick = sendChat;
            chatInput.onkeydown = (e) => { if (e.key === 'Enter') sendChat(); };

            // --- INITIALIZATION ---
            loadState();
            renderAll();
            window.onresize = renderAll;
        
        }); // END of DOMContentLoaded wrapper
    </script>
</body>
</html>
